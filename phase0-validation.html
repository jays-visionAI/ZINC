<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 0 Data Validation</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            padding: 20px;
            background: #0a0e27;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .validation-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section h2 {
            color: #16e0bd;
            margin-top: 0;
        }

        .result {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .success {
            border-left: 4px solid #22c55e;
        }

        .warning {
            border-left: 4px solid #fbbf24;
        }

        .error {
            border-left: 4px solid #ef4444;
        }

        .field {
            margin: 5px 0;
        }

        .field-name {
            color: #16e0bd;
            font-weight: 600;
        }

        .field-value {
            color: #a0aec0;
        }

        button {
            background: #16e0bd;
            color: #0a0e27;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
        }

        button:hover {
            background: #14c9a8;
        }
    </style>
</head>

<body>
    <div class="validation-container">
        <h1>üîç Phase 0 Data Validation</h1>
        <p>This tool validates the Firestore data structure for ZYNK Agent OS PRD 5.0 Phase 0.</p>

        <div class="section">
            <h2>1. Sub-Agent Templates Validation</h2>
            <button onclick="validateSubAgents()">Validate Sub-Agent Templates</button>
            <div id="subagent-results"></div>
        </div>

        <div class="section">
            <h2>2. Agent Team Templates Validation</h2>
            <button onclick="validateTeamTemplates()">Validate Team Templates</button>
            <div id="team-results"></div>
        </div>

        <div class="section">
            <h2>3. Project Agent Team Instances Validation</h2>
            <button onclick="validateInstances()">Validate Instances</button>
            <div id="instance-results"></div>
        </div>

        <div class="section">
            <h2>4. Engine Type Consistency Check</h2>
            <button onclick="checkEngineTypeConsistency()">Check Consistency</button>
            <div id="consistency-results"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // Expected canonical engine types
        const CANONICAL_TYPES = [
            'planner', 'research', 'creator_text', 'creator_image',
            'creator_video', 'engagement', 'compliance', 'evaluator',
            'manager', 'kpi', 'seo_watcher'
        ];

        async function validateSubAgents() {
            const resultsDiv = document.getElementById('subagent-results');
            resultsDiv.innerHTML = '<p>Loading...</p>';

            try {
                const snapshot = await db.collection('subAgentTemplates').limit(10).get();

                if (snapshot.empty) {
                    resultsDiv.innerHTML = '<div class="result warning">‚ö†Ô∏è No Sub-Agent templates found</div>';
                    return;
                }

                let html = `<p>Found ${snapshot.size} templates (showing first 10):</p>`;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const hasEngineType = !!data.type;
                    const isCanonical = CANONICAL_TYPES.includes(data.type);
                    const className = hasEngineType && isCanonical ? 'success' : 'warning';

                    html += `<div class="result ${className}">
                        <div class="field"><span class="field-name">ID:</span> <span class="field-value">${doc.id}</span></div>
                        <div class="field"><span class="field-name">engineType:</span> <span class="field-value">${data.type || 'MISSING'}</span></div>
                        <div class="field"><span class="field-name">Canonical:</span> <span class="field-value">${isCanonical ? '‚úÖ Yes' : '‚ùå No (legacy format)'}</span></div>
                        <div class="field"><span class="field-name">Version:</span> <span class="field-value">${data.version || 'N/A'}</span></div>
                        <div class="field"><span class="field-name">Status:</span> <span class="field-value">${data.status || 'N/A'}</span></div>
                    </div>`;
                });

                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function validateTeamTemplates() {
            const resultsDiv = document.getElementById('team-results');
            resultsDiv.innerHTML = '<p>Loading...</p>';

            try {
                const snapshot = await db.collection('agentSetTemplates').limit(10).get();

                if (snapshot.empty) {
                    resultsDiv.innerHTML = '<div class="result warning">‚ö†Ô∏è No Agent Team templates found</div>';
                    return;
                }

                let html = `<p>Found ${snapshot.size} templates (showing first 10):</p>`;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const roles = data.roles || [];
                    const hasRoles = roles.length > 0;
                    const allRolesHaveEngineType = roles.every(r => !!r.type);
                    const allRolesCanonical = roles.every(r => CANONICAL_TYPES.includes(r.type));
                    const hasBehaviourPackField = roles.some(r => 'behaviourPackId' in r);

                    const className = hasRoles && allRolesHaveEngineType && allRolesCanonical ? 'success' : 'warning';

                    html += `<div class="result ${className}">
                        <div class="field"><span class="field-name">ID:</span> <span class="field-value">${doc.id}</span></div>
                        <div class="field"><span class="field-name">Name:</span> <span class="field-value">${data.name || 'N/A'}</span></div>
                        <div class="field"><span class="field-name">Roles Count:</span> <span class="field-value">${roles.length}</span></div>
                        <div class="field"><span class="field-name">All Roles Have engineType:</span> <span class="field-value">${allRolesHaveEngineType ? '‚úÖ Yes' : '‚ùå No'}</span></div>
                        <div class="field"><span class="field-name">All Canonical:</span> <span class="field-value">${allRolesCanonical ? '‚úÖ Yes' : '‚ö†Ô∏è No (legacy format)'}</span></div>
                        <div class="field"><span class="field-name">Has behaviourPackId field:</span> <span class="field-value">${hasBehaviourPackField ? '‚úÖ Yes (Phase 1 ready)' : '‚ö†Ô∏è No'}</span></div>
                        ${roles.length > 0 ? `<div class="field"><span class="field-name">Roles:</span><br>${roles.map(r => `&nbsp;&nbsp;‚Ä¢ ${r.name || 'Unnamed'} (${r.type || 'no type'})`).join('<br>')}</div>` : ''}
                    </div>`;
                });

                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function validateInstances() {
            const resultsDiv = document.getElementById('instance-results');
            resultsDiv.innerHTML = '<p>Loading...</p>';

            try {
                const snapshot = await db.collection('projectAgentTeamInstances').limit(10).get();

                if (snapshot.empty) {
                    resultsDiv.innerHTML = '<div class="result warning">‚ö†Ô∏è No Project Agent Team instances found</div>';
                    return;
                }

                let html = `<p>Found ${snapshot.size} instances (showing first 10):</p>`;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const hasConfigProfile = !!data.configProfileId;
                    const hasEngineVersionSet = !!data.engineVersionSet;
                    const hasChannel = !!data.channel;
                    const hasRuleProfile = 'ruleProfileId' in data;

                    const allPresent = hasConfigProfile && hasEngineVersionSet && hasChannel;
                    const className = allPresent ? 'success' : 'warning';

                    html += `<div class="result ${className}">
                        <div class="field"><span class="field-name">ID:</span> <span class="field-value">${doc.id}</span></div>
                        <div class="field"><span class="field-name">Name:</span> <span class="field-value">${data.name || 'N/A'}</span></div>
                        <div class="field"><span class="field-name">Project ID:</span> <span class="field-value">${data.projectId || 'N/A'}</span></div>
                        <div class="field"><span class="field-name">configProfileId:</span> <span class="field-value">${data.configProfileId || '‚ùå MISSING'}</span></div>
                        <div class="field"><span class="field-name">engineVersionSet:</span> <span class="field-value">${data.engineVersionSet || '‚ùå MISSING'}</span></div>
                        <div class="field"><span class="field-name">channel:</span> <span class="field-value">${data.channel || '‚ùå MISSING'}</span></div>
                        <div class="field"><span class="field-name">ruleProfileId:</span> <span class="field-value">${hasRuleProfile ? (data.ruleProfileId || 'null (Phase 1 ready)') : '‚ö†Ô∏è Field not present'}</span></div>
                        <div class="field"><span class="field-name">Status:</span> <span class="field-value">${data.status || 'N/A'}</span></div>
                    </div>`;
                });

                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function checkEngineTypeConsistency() {
            const resultsDiv = document.getElementById('consistency-results');
            resultsDiv.innerHTML = '<p>Checking consistency...</p>';

            try {
                // Get all unique engine types from subAgentTemplates
                const subAgentSnapshot = await db.collection('subAgentTemplates').get();
                const engineTypes = new Set();
                const legacyTypes = new Set();

                subAgentSnapshot.forEach(doc => {
                    const type = doc.data().type;
                    if (type) {
                        if (CANONICAL_TYPES.includes(type)) {
                            engineTypes.add(type);
                        } else {
                            legacyTypes.add(type);
                        }
                    }
                });

                let html = '<h3>Engine Type Summary</h3>';
                html += `<div class="result ${legacyTypes.size === 0 ? 'success' : 'warning'}">`;
                html += `<div class="field"><span class="field-name">Canonical Types Found:</span> <span class="field-value">${engineTypes.size} types</span></div>`;
                html += `<div class="field"><span class="field-name">Types:</span> <span class="field-value">${Array.from(engineTypes).join(', ') || 'None'}</span></div>`;
                html += `</div>`;

                if (legacyTypes.size > 0) {
                    html += `<div class="result warning">`;
                    html += `<div class="field"><span class="field-name">‚ö†Ô∏è Legacy Types Found:</span> <span class="field-value">${legacyTypes.size} types</span></div>`;
                    html += `<div class="field"><span class="field-name">Types:</span> <span class="field-value">${Array.from(legacyTypes).join(', ')}</span></div>`;
                    html += `<div class="field"><span class="field-value">These should be migrated to canonical snake_case format</span></div>`;
                    html += `</div>`;
                }

                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }
        }
    </script>
</body>

</html>