<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standalone Config UI Test</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="admin-detail.css">
    <style>
        body {
            background-color: #0A0A0F;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .dashboard-layout {
            padding: 20px;
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
        }
    </style>
</head>

<body>

    <div class="dashboard-layout">
        <h1>Config UI Component Test</h1>
        <button class="admin-btn-primary" id="btn-open-config">Open Config Panel</button>
    </div>

    <!-- Configuration Slide-in Panel -->
    <div class="config-panel-overlay" id="config-overlay"></div>
    <div class="config-panel" id="config-panel">
        <div class="config-header">
            <button class="config-close" id="config-close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="config-title">
                <span id="config-channel-icon">üê¶</span>
                <span id="config-channel-name">Test Channel</span>
            </div>
            <div class="config-subtitle">
                <span id="config-template-name">Template: Test Template</span>
                <span id="config-profile-name">Runtime Profile: Test Profile</span>
            </div>
        </div>

        <div class="config-tabs">
            <div class="config-tab active" data-tab="goals">üéØ Goals & KPI</div>
            <div class="config-tab" data-tab="planner">üìù Content Strategy</div>
            <div class="config-tab" data-tab="creator_text">üí¨ Tone & Copy</div>
            <div class="config-tab" data-tab="engagement">ü§ñ Engagement</div>
            <div class="config-tab" data-tab="advanced">‚öôÔ∏è Advanced</div>
        </div>

        <div class="config-content" id="config-content">
            <!-- Dynamic Content Loaded Here -->
        </div>

        <div class="config-footer">
            <button class="admin-btn-secondary" id="config-reset-all">Reset All to Template</button>
            <button class="admin-btn-primary" id="config-save">Save Changes</button>
        </div>
    </div>

    <script>
        // Mock Data
        const currentConfigData = {
            goals: { followers: 0.25, engagement: 0.35, clicks: 0.25, impressions: 0.15 },
            planner: { postFrequency: 'medium', formatMix: { shortTweet: 60, thread: 80, imagePost: 30, videoPost: 10 }, experimentIntensity: 'medium', avgThreadLength: 7 },
            creator_text: { tonePreset: 'professional', hookStyle: ['question', 'stat'], emojiUsage: 'minimal', hashtagCount: 3, ctaIntensity: 'medium' },
            engagement: { autoReplyLevel: 'medium', dailyReplyCap: 50, replyToMentions: true, replyToKeywords: ['pricing'], escalationTriggers: ['complaint'] },
            advanced: { seoOptimization: true, linkPreviewOptimization: true, threadStructure: 'linear', retweetStrategy: 'selective' }
        };

        let currentOverrides = {};

        // --- Render Logic (Copied from project-detail.js) ---

        function renderConfigUI() {
            const container = document.getElementById('config-content');
            container.innerHTML = '';

            // 1. Goals Tab
            const goalsSection = createSection('goals', true);
            goalsSection.innerHTML = renderGoalsTab(currentConfigData.goals);
            container.appendChild(goalsSection);

            // 2. Planner Tab
            const plannerSection = createSection('planner', false);
            plannerSection.innerHTML = renderPlannerTab(currentConfigData.planner);
            container.appendChild(plannerSection);

            // 3. Creator Text Tab
            const creatorSection = createSection('creator_text', false);
            creatorSection.innerHTML = renderCreatorTab(currentConfigData.creator_text);
            container.appendChild(creatorSection);

            // 4. Engagement Tab
            const engagementSection = createSection('engagement', false);
            engagementSection.innerHTML = renderEngagementTab(currentConfigData.engagement);
            container.appendChild(engagementSection);

            // 5. Advanced Tab
            const advancedSection = createSection('advanced', false);
            advancedSection.innerHTML = renderAdvancedTab(currentConfigData.advanced || {});
            container.appendChild(advancedSection);

            // Re-attach listeners for inputs
            attachInputListeners();
        }

        function createSection(id, isActive) {
            const div = document.createElement('div');
            div.id = `config-section-${id}`;
            div.className = `config-section ${isActive ? 'active' : ''}`;
            return div;
        }

        function renderGoalsTab(config) {
            return `
                <div class="config-group">
                    <label class="config-label">Goal Priorities</label>
                    <div class="config-description">Adjust the relative importance of each metric. Total should ideally sum to 100%.</div>
                    ${renderSlider('goals', 'followers', 'Follower Growth', config.followers || 0.25, 0, 1, 0.05, true)}
                    ${renderSlider('goals', 'engagement', 'Engagement', config.engagement || 0.35, 0, 1, 0.05, true)}
                    ${renderSlider('goals', 'clicks', 'Link Clicks', config.clicks || 0.25, 0, 1, 0.05, true)}
                    ${renderSlider('goals', 'impressions', 'Impressions', config.impressions || 0.15, 0, 1, 0.05, true)}
                </div>
            `;
        }

        function renderPlannerTab(config) {
            return `
                <div class="config-group">
                    <label class="config-label">Posting Frequency</label>
                    <select class="config-select" data-engine="planner" data-key="postFrequency">
                        <option value="low" ${config.postFrequency === 'low' ? 'selected' : ''}>Low (1-3/day)</option>
                        <option value="medium" ${config.postFrequency === 'medium' ? 'selected' : ''}>Medium (3-5/day)</option>
                        <option value="high" ${config.postFrequency === 'high' ? 'selected' : ''}>High (5-10/day)</option>
                        <option value="aggressive" ${config.postFrequency === 'aggressive' ? 'selected' : ''}>Aggressive (10+/day)</option>
                    </select>
                </div>

                <div class="config-group">
                    <label class="config-label">Format Mix</label>
                    ${renderSlider('planner', 'formatMix.shortTweet', 'Short Tweet', config.formatMix?.shortTweet || 60, 0, 100)}
                    ${renderSlider('planner', 'formatMix.thread', 'Thread', config.formatMix?.thread || 80, 0, 100)}
                    ${renderSlider('planner', 'formatMix.imagePost', 'Image Post', config.formatMix?.imagePost || 30, 0, 100)}
                    ${renderSlider('planner', 'formatMix.videoPost', 'Video Post', config.formatMix?.videoPost || 10, 0, 100)}
                </div>

                <div class="config-group">
                    <label class="config-label">Experiment Intensity</label>
                    <select class="config-select" data-engine="planner" data-key="experimentIntensity">
                        <option value="low" ${config.experimentIntensity === 'low' ? 'selected' : ''}>Low (Safe)</option>
                        <option value="medium" ${config.experimentIntensity === 'medium' ? 'selected' : ''}>Medium (Balanced)</option>
                        <option value="high" ${config.experimentIntensity === 'high' ? 'selected' : ''}>High (Experimental)</option>
                        <option value="aggressive" ${config.experimentIntensity === 'aggressive' ? 'selected' : ''}>Aggressive</option>
                    </select>
                </div>

                <div class="config-group">
                    <label class="config-label">Thread Length</label>
                    ${renderSlider('planner', 'avgThreadLength', 'Target Length (Tweets)', config.avgThreadLength || 7, 3, 25, 1)}
                </div>
            `;
        }

        function renderCreatorTab(config) {
            return `
                <div class="config-group">
                    <label class="config-label">Tone Preset</label>
                    <select class="config-select" data-engine="creator_text" data-key="tonePreset">
                        <option value="calm" ${config.tonePreset === 'calm' ? 'selected' : ''}>Calm & Thoughtful</option>
                        <option value="professional" ${config.tonePreset === 'professional' ? 'selected' : ''}>Professional & Clear</option>
                        <option value="bold" ${config.tonePreset === 'bold' ? 'selected' : ''}>Bold & Confident</option>
                        <option value="humorous" ${config.tonePreset === 'humorous' ? 'selected' : ''}>Humorous & Witty</option>
                        <option value="provocative" ${config.tonePreset === 'provocative' ? 'selected' : ''}>Provocative & Contrarian</option>
                    </select>
                </div>

                <div class="config-group">
                    <label class="config-label">Hook Style (Select 1-3)</label>
                    ${renderMultiSelect('creator_text', 'hookStyle', [
                { value: 'question', label: 'Question ("What if...")' },
                { value: 'stat', label: 'Statistic ("93% of...")' },
                { value: 'story', label: 'Story ("Last week...")' },
                { value: 'contrarian', label: 'Contrarian ("Everyone is wrong...")' },
                { value: 'value_prop', label: 'Value Prop ("How to 10x...")' }
            ], config.hookStyle || ['question', 'stat'])}
                </div>

                <div class="config-group">
                    <label class="config-label">Style Details</label>
                    ${renderSlider('creator_text', 'hashtagCount', 'Hashtags per Post', config.hashtagCount || 3, 0, 5, 1)}
                    
                    <div style="margin-top: 16px;">
                        <label class="config-label" style="font-size: 12px;">Emoji Usage</label>
                        <select class="config-select" data-engine="creator_text" data-key="emojiUsage">
                            <option value="none" ${config.emojiUsage === 'none' ? 'selected' : ''}>None</option>
                            <option value="minimal" ${config.emojiUsage === 'minimal' ? 'selected' : ''}>Minimal (1-2)</option>
                            <option value="moderate" ${config.emojiUsage === 'moderate' ? 'selected' : ''}>Moderate (3-5)</option>
                            <option value="high" ${config.emojiUsage === 'high' ? 'selected' : ''}>High (5+)</option>
                        </select>
                    </div>

                    <div style="margin-top: 16px;">
                        <label class="config-label" style="font-size: 12px;">Call-to-Action Intensity</label>
                        <select class="config-select" data-engine="creator_text" data-key="ctaIntensity">
                            <option value="soft" ${config.ctaIntensity === 'soft' ? 'selected' : ''}>Soft ("Learn more")</option>
                            <option value="medium" ${config.ctaIntensity === 'medium' ? 'selected' : ''}>Medium ("Check it out")</option>
                            <option value="aggressive" ${config.ctaIntensity === 'aggressive' ? 'selected' : ''}>Aggressive ("Sign up NOW")</option>
                        </select>
                    </div>
                </div>
            `;
        }

        function renderEngagementTab(config) {
            return `
                <div class="config-group">
                    <label class="config-label">Auto-Reply Level</label>
                    <select class="config-select" data-engine="engagement" data-key="autoReplyLevel">
                        <option value="off" ${config.autoReplyLevel === 'off' ? 'selected' : ''}>Off (Manual Only)</option>
                        <option value="low" ${config.autoReplyLevel === 'low' ? 'selected' : ''}>Low (@Mentions Only)</option>
                        <option value="medium" ${config.autoReplyLevel === 'medium' ? 'selected' : ''}>Medium (+ Keywords)</option>
                        <option value="high" ${config.autoReplyLevel === 'high' ? 'selected' : ''}>High (Proactive)</option>
                    </select>
                </div>

                <div class="config-group">
                    <label class="config-label">Daily Reply Cap</label>
                    ${renderSlider('engagement', 'dailyReplyCap', 'Max Replies/Day', config.dailyReplyCap || 50, 0, 200, 5)}
                </div>

                <div class="config-group">
                    <label class="config-label">Reply Triggers</label>
                    ${renderToggle('engagement', 'replyToMentions', 'Reply to @Mentions', config.replyToMentions !== false)}
                    
                    <div style="margin-top: 12px;">
                        <label class="config-label" style="font-size: 12px;">Keywords (Press Enter)</label>
                        ${renderTagInput('engagement', 'replyToKeywords', config.replyToKeywords || [])}
                    </div>
                </div>

                <div class="config-group">
                    <label class="config-label">Escalation Rules (Alert Human)</label>
                    ${renderMultiSelect('engagement', 'escalationTriggers', [
                { value: 'negative_sentiment', label: 'Negative Sentiment' },
                { value: 'complaint', label: 'Complaints' },
                { value: 'support_question', label: 'Support Questions' },
                { value: 'pricing_inquiry', label: 'Pricing Inquiries' }
            ], config.escalationTriggers || ['complaint'])}
                </div>
            `;
        }

        function renderAdvancedTab(config) {
            return `
                <div class="config-group">
                    <label class="config-label">Optimization</label>
                    ${renderToggle('advanced', 'seoOptimization', 'SEO Optimization', config.seoOptimization !== false)}
                    ${renderToggle('advanced', 'linkPreviewOptimization', 'Rich Link Previews', config.linkPreviewOptimization !== false)}
                </div>

                <div class="config-group">
                    <label class="config-label">Structure Strategy</label>
                    <div style="margin-bottom: 12px;">
                        <label class="config-label" style="font-size: 12px;">Thread Structure</label>
                        <select class="config-select" data-engine="advanced" data-key="threadStructure">
                            <option value="linear" ${config.threadStructure === 'linear' ? 'selected' : ''}>Linear (Standard)</option>
                            <option value="branching" ${config.threadStructure === 'branching' ? 'selected' : ''}>Branching (Complex)</option>
                        </select>
                    </div>
                    <div>
                        <label class="config-label" style="font-size: 12px;">Retweet Strategy</label>
                        <select class="config-select" data-engine="advanced" data-key="retweetStrategy">
                            <option value="off" ${config.retweetStrategy === 'off' ? 'selected' : ''}>Off</option>
                            <option value="selective" ${config.retweetStrategy === 'selective' ? 'selected' : ''}>Selective (High Performers)</option>
                            <option value="aggressive" ${config.retweetStrategy === 'aggressive' ? 'selected' : ''}>Aggressive</option>
                        </select>
                    </div>
                </div>
            `;
        }

        function renderSlider(engine, key, label, value, min, max, step = 1, isPercent = false) {
            const displayValue = isPercent ? `${Math.round(value * 100)}%` : value;
            return `
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-size: 12px; color: rgba(255,255,255,0.7);">${label}</span>
                        <span class="config-value" id="val-${engine}-${key.replace('.', '-')}">${displayValue}</span>
                    </div>
                    <div class="config-slider-container">
                        <input type="range" class="config-slider" 
                            data-engine="${engine}" data-key="${key}"
                            min="${min}" max="${max}" step="${step}" value="${value}"
                            oninput="document.getElementById('val-${engine}-${key.replace('.', '-')}').textContent = ${isPercent} ? Math.round(this.value * 100) + '%' : this.value">
                    </div>
                </div>
            `;
        }

        function renderMultiSelect(engine, key, options, selectedValues) {
            const items = options.map(opt => {
                const isChecked = selectedValues.includes(opt.value);
                return `
                    <label class="config-checkbox-item">
                        <input type="checkbox" class="config-multi-checkbox" 
                            data-engine="${engine}" data-key="${key}" value="${opt.value}"
                            ${isChecked ? 'checked' : ''}>
                        ${opt.label}
                    </label>
                `;
            }).join('');

            return `<div class="config-multiselect-container">${items}</div>`;
        }

        function renderToggle(engine, key, label, isChecked) {
            return `
                <div class="config-toggle-container">
                    <span class="config-toggle-label">${label}</span>
                    <label class="config-toggle">
                        <input type="checkbox" class="config-toggle-input" 
                            data-engine="${engine}" data-key="${key}"
                            ${isChecked ? 'checked' : ''}>
                        <span class="config-toggle-slider"></span>
                    </label>
                </div>
            `;
        }

        function renderTagInput(engine, key, tags) {
            const tagItems = tags.map(tag => `
                <span class="config-tag">
                    ${tag}
                    <span class="config-tag-remove" data-tag="${tag}" data-engine="${engine}" data-key="${key}">&times;</span>
                </span>
            `).join('');

            return `
                <div class="config-tag-container" id="tags-${engine}-${key}">
                    ${tagItems}
                    <input type="text" class="config-tag-input" 
                        data-engine="${engine}" data-key="${key}" 
                        placeholder="Add keyword...">
                </div>
            `;
        }

        function attachInputListeners() {
            // 1. Sliders & Selects
            document.querySelectorAll('.config-slider, .config-select').forEach(input => {
                input.addEventListener('change', (e) => {
                    updateConfigValue(e.target.dataset.engine, e.target.dataset.key, e.target.value, e.target.type);
                });
            });

            // 2. Toggles (Single Checkbox)
            document.querySelectorAll('.config-toggle-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    updateConfigValue(e.target.dataset.engine, e.target.dataset.key, e.target.checked);
                });
            });

            // 3. Multi-Select (Checkbox Group)
            document.querySelectorAll('.config-multi-checkbox').forEach(input => {
                input.addEventListener('change', (e) => {
                    const engine = e.target.dataset.engine;
                    const key = e.target.dataset.key;
                    const value = e.target.value;

                    let currentArray = getDeepValue(currentOverrides, engine, key);
                    if (currentArray === undefined) {
                        currentArray = getDeepValue(currentConfigData, engine, key) || [];
                        currentArray = [...currentArray];
                    }

                    if (e.target.checked) {
                        if (!currentArray.includes(value)) currentArray.push(value);
                    } else {
                        currentArray = currentArray.filter(v => v !== value);
                    }

                    updateConfigValue(engine, key, currentArray);
                });
            });

            // 4. Tag Inputs
            document.querySelectorAll('.config-tag-input').forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const tag = e.target.value.trim();
                        if (!tag) return;

                        const engine = e.target.dataset.engine;
                        const key = e.target.dataset.key;

                        let currentTags = getDeepValue(currentOverrides, engine, key);
                        if (currentTags === undefined) {
                            currentTags = getDeepValue(currentConfigData, engine, key) || [];
                            currentTags = [...currentTags];
                        }

                        if (!currentTags.includes(tag)) {
                            currentTags.push(tag);
                            updateConfigValue(engine, key, currentTags);

                            const container = document.getElementById(`tags-${engine}-${key}`);
                            const span = document.createElement('span');
                            span.className = 'config-tag';
                            span.innerHTML = `${tag} <span class="config-tag-remove" data-tag="${tag}" data-engine="${engine}" data-key="${key}">&times;</span>`;
                            container.insertBefore(span, input);

                            span.querySelector('.config-tag-remove').addEventListener('click', handleTagRemove);
                        }
                        e.target.value = '';
                    }
                });
            });

            document.querySelectorAll('.config-tag-remove').forEach(btn => {
                btn.addEventListener('click', handleTagRemove);
            });
        }

        function handleTagRemove(e) {
            const engine = e.target.dataset.engine;
            const key = e.target.dataset.key;
            const tagToRemove = e.target.dataset.tag;

            let currentTags = getDeepValue(currentOverrides, engine, key);
            if (currentTags === undefined) {
                currentTags = getDeepValue(currentConfigData, engine, key) || [];
                currentTags = [...currentTags];
            }

            currentTags = currentTags.filter(t => t !== tagToRemove);
            updateConfigValue(engine, key, currentTags);

            e.target.parentElement.remove();
        }

        function updateConfigValue(engine, key, value, type) {
            if (type === 'range') {
                value = parseFloat(value);
            }

            if (!currentOverrides[engine]) currentOverrides[engine] = {};

            if (key.includes('.')) {
                const [parent, child] = key.split('.');
                if (!currentOverrides[engine][parent]) {
                    const existingParent = currentConfigData[engine]?.[parent] || {};
                    currentOverrides[engine][parent] = { ...existingParent };
                }
                currentOverrides[engine][parent][child] = value;
            } else {
                currentOverrides[engine][key] = value;
            }

            console.log('Config changed:', currentOverrides);
        }

        function getDeepValue(obj, engine, key) {
            if (!obj || !obj[engine]) return undefined;
            if (key.includes('.')) {
                const [parent, child] = key.split('.');
                return obj[engine][parent]?.[child];
            }
            return obj[engine][key];
        }

        // --- Event Listeners ---

        const configOverlay = document.getElementById('config-overlay');
        const configPanel = document.getElementById('config-panel');
        const configClose = document.getElementById('config-close');
        const configSave = document.getElementById('config-save');

        function openConfigPanel() {
            configOverlay.classList.add('active');
            configPanel.classList.add('active');
            renderConfigUI();
        }

        function closeConfigPanel() {
            configOverlay.classList.remove('active');
            configPanel.classList.remove('active');
        }

        document.getElementById('btn-open-config').addEventListener('click', openConfigPanel);
        configClose.addEventListener('click', closeConfigPanel);
        configOverlay.addEventListener('click', closeConfigPanel);
        configSave.addEventListener('click', () => {
            alert('Config Saved (Mock)! Check console for overrides object.');
            console.log('Final Overrides:', currentOverrides);
            closeConfigPanel();
        });

        // Tab Switching
        document.querySelectorAll('.config-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.config-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.config-section').forEach(s => s.classList.remove('active'));

                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                const section = document.getElementById(`config-section-${tabName}`);
                if (section) section.classList.add('active');
            });
        });

        // Auto-open on load
        openConfigPanel();

    </script>
</body>

</html>