<!-- ============================================
     Workflow Canvas Builder - HTML Template
     ============================================ -->

<div id="workflow-canvas-modal" class="workflow-canvas-modal">
    <!-- Header -->
    <header class="wf-header">
        <div class="wf-header-left">
            <button class="wf-back-btn" onclick="WorkflowCanvas.close()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    style="width:16px;height:16px;">
                    <polyline points="15 18 9 12 15 6" />
                </svg>
                <span>Back to Pipeline</span>
            </button>
            <h1 class="wf-title">Workflow Canvas Builder</h1>
        </div>
        <div class="wf-header-right">
            <button class="wf-btn wf-btn-secondary" onclick="WorkflowCanvas.reset()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    style="width:16px;height:16px;">
                    <path d="M1 4v6h6" />
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
                </svg>
                <span>Reset</span>
            </button>
            <button class="wf-btn wf-btn-secondary" onclick="WorkflowCanvas.saveAsDraft()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    style="width:16px;height:16px;">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                    <polyline points="17 21 17 13 7 13 7 21" />
                    <polyline points="7 3 7 8 15 8" />
                </svg>
                <span>Save Draft</span>
            </button>
            <button class="wf-btn wf-btn-primary" onclick="WorkflowCanvas.saveAndRun()">
                <svg viewBox="0 0 24 24" fill="currentColor" style="width:14px;height:14px;">
                    <polygon points="5,3 19,12 5,21" />
                </svg>
                <span>Save & Run</span>
            </button>
        </div>
    </header>

    <!-- Step Tabs -->
    <nav class="wf-steps">
        <button class="wf-step-tab active" data-step="1" onclick="WorkflowCanvas.goToStep(1)">
            <span class="wf-step-number">1</span>
            <span>Prompt</span>
        </button>
        <button class="wf-step-tab" data-step="2" onclick="WorkflowCanvas.goToStep(2)">
            <span class="wf-step-number">2</span>
            <span>Canvas</span>
        </button>
        <button class="wf-step-tab" data-step="3" onclick="WorkflowCanvas.goToStep(3)">
            <span class="wf-step-number">3</span>
            <span>Code</span>
        </button>
    </nav>

    <!-- Main Content -->
    <main class="wf-main">
        <!-- Step 1: Prompt Input -->
        <div id="wf-step-1" class="wf-step-content active">
            <div class="wf-prompt-container">
                <div class="wf-prompt-card">
                    <div class="wf-prompt-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            style="width:32px;height:32px;">
                            <path d="M12 3v1" />
                            <path d="M12 20v1" />
                            <path d="M3 12h1" />
                            <path d="M20 12h1" />
                            <path d="M18.364 5.636l-.707.707" />
                            <path d="M18.364 18.364l-.707-.707" />
                            <path d="M5.636 5.636l-.707.707" />
                            <path d="M5.636 18.364l-.707-.707" />
                        </svg>
                    </div>
                    <h2 class="wf-prompt-title">ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º ÏûêÏó∞Ïñ¥Î°ú ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî</h2>
                    <p class="wf-prompt-subtitle">
                        AIÍ∞Ä Î∂ÑÏÑùÌïòÏó¨ ÏµúÏ†ÅÏùò ÏóêÏù¥Ï†ÑÌä∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º ÏûêÎèôÏúºÎ°ú Íµ¨ÏÑ±Ìï©ÎãàÎã§.<br>
                        Î≥µÏû°Ìïú Ï°∞Í±¥Ïù¥ÎÇò Î≥ëÎ†¨ Ï≤òÎ¶¨ÎèÑ ÏûêÏó∞Ïä§ÎüΩÍ≤å ÏÑ§Î™ÖÌï¥Î≥¥ÏÑ∏Ïöî.
                    </p>

                    <textarea id="wf-prompt-input" class="wf-prompt-textarea"
                        placeholder="Ïòà: Î®ºÏ†Ä ÏãúÏû• Ìä∏Î†åÎìúÎ•º Î∂ÑÏÑùÌïòÍ≥†, Í≤∞Í≥ºÍ∞Ä Ïú†ÏùòÎØ∏ÌïòÎ©¥ ÏΩòÌÖêÏ∏† Í∏∞ÌöçÏùÑ ÏßÑÌñâÌïòÍ≥†, ÏïÑÎãàÎ©¥ Ï∂îÍ∞Ä Î¶¨ÏÑúÏπòÎ•º Ìï¥Ï§ò. Í∏∞ÌöçÏù¥ ÎÅùÎÇòÎ©¥ Í∏Ä ÏûëÏÑ±Í≥º Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±ÏùÑ ÎèôÏãúÏóê ÏßÑÌñâÌï¥Ï§ò."></textarea>

                    <div class="wf-prompt-actions">
                        <button class="wf-btn wf-btn-primary" onclick="WorkflowCanvas.analyzePrompt()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                style="width:16px;height:16px;">
                                <path d="M15 4V2" />
                                <path d="M15 16v-2" />
                                <path d="M8 9h2" />
                                <path d="M20 9h2" />
                                <path d="M17.8 5.2l-1.4 1.4" />
                                <path d="M17.8 12.8l-1.4-1.4" />
                                <path d="M12.2 5.2l1.4 1.4" />
                                <path d="M12.2 12.8l-1.4-1.4" />
                                <path d="M9 14l-6 6" />
                                <path d="M6 14l-3 3" />
                                <path d="M9 17l-3 3" />
                            </svg>
                            <span>AIÎ°ú ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏÉùÏÑ±</span>
                        </button>
                        <button class="wf-btn wf-btn-secondary" onclick="WorkflowCanvas.showTemplates()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                style="width:16px;height:16px;">
                                <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                            </svg>
                            <span>ÌÖúÌîåÎ¶øÏóêÏÑú ÏÑ†ÌÉù</span>
                        </button>
                    </div>

                    <!-- AI Analysis Result -->
                    <div id="wf-analysis-result" class="wf-analysis-result">
                        <div class="wf-analysis-header">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                style="width:18px;height:18px;">
                                <circle cx="12" cy="8" r="4" />
                                <path d="M4 20v-2a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v2" />
                            </svg>
                            <h4>AI Î∂ÑÏÑù Í≤∞Í≥º</h4>
                        </div>
                        <div id="wf-detected-agents" class="wf-detected-agents">
                            <!-- Filled by JS -->
                        </div>
                        <div id="wf-flow-description" class="wf-flow-description">
                            <!-- Filled by JS -->
                        </div>
                        <div class="wf-analysis-actions">
                            <button class="wf-btn wf-btn-primary" onclick="WorkflowCanvas.applyToCanvas()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    style="width:16px;height:16px;">
                                    <path d="M12 3v1" />
                                    <path d="M12 20v1" />
                                    <path d="M3 12h1" />
                                    <path d="M20 12h1" />
                                    <path d="M18.364 5.636l-.707.707" />
                                    <path d="M18.364 18.364l-.707-.707" />
                                    <path d="M5.636 5.636l-.707.707" />
                                    <path d="M5.636 18.364l-.707-.707" />
                                </svg>
                                <span>Ï∫îÎ≤ÑÏä§Ïóê Ï†ÅÏö©</span>
                            </button>
                            <button class="wf-btn wf-btn-secondary" onclick="WorkflowCanvas.refineAnalysis()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    style="width:14px;height:14px;">
                                    <path d="M12 19l7-7 3 3-7 7-3-3z" />
                                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" />
                                    <path d="M2 2l7.586 7.586" />
                                </svg>
                                <span>ÏàòÏ†ï ÏöîÏ≤≠</span>
                            </button>
                        </div>
                    </div>

                    <!-- Available Agents -->
                    <div class="wf-available-agents">
                        <h5>ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏóêÏù¥Ï†ÑÌä∏</h5>
                        <div id="wf-agent-chips" class="wf-agent-chips">
                            <!-- Filled by JS based on pipeline context -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Canvas Editor -->
        <div id="wf-step-2" class="wf-step-content">
            <div class="wf-canvas-container">
                <!-- Canvas Area -->
                <div class="wf-canvas-area" id="wf-canvas-area">
                    <!-- Zoom Controls -->
                    <div class="wf-zoom-controls">
                        <button class="wf-zoom-btn" onclick="WorkflowCanvas.zoomIn()" title="Zoom In">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                                style="width:18px;height:18px;">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                        </button>
                        <button class="wf-zoom-btn" onclick="WorkflowCanvas.zoomOut()" title="Zoom Out">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                                style="width:18px;height:18px;">
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                        </button>
                        <button class="wf-zoom-btn" onclick="WorkflowCanvas.zoomReset()" title="Reset Zoom">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                style="width:18px;height:18px;">
                                <path d="M1 4v6h6" />
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
                            </svg>
                        </button>
                        <button class="wf-zoom-btn wf-tidy-btn" onclick="WorkflowCanvas.tidyUp()"
                            title="Tidy Up Layout">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                style="width:18px;height:18px;">
                                <path d="M12 3v1" />
                                <path d="M12 20v1" />
                                <path d="M3 12h1" />
                                <path d="M20 12h1" />
                                <path d="M18.364 5.636l-.707.707" />
                                <path d="M18.364 18.364l-.707-.707" />
                                <path d="M5.636 5.636l-.707.707" />
                                <path d="M5.636 18.364l-.707-.707" />
                            </svg>
                        </button>
                    </div>

                    <!-- Canvas Viewport -->
                    <div class="wf-canvas-viewport" id="wf-canvas-viewport">
                        <!-- SVG for connections -->
                        <svg class="wf-connections-svg" id="wf-connections-svg"></svg>

                        <!-- Nodes container -->
                        <div class="wf-nodes-container" id="wf-nodes-container">
                            <!-- Nodes inserted here by JS -->
                        </div>
                    </div>

                    <!-- Minimap -->
                    <div class="wf-minimap" id="wf-minimap">
                        <div class="wf-minimap-viewport" id="wf-minimap-viewport"></div>
                    </div>

                    <!-- Agent Palette -->
                    <div class="wf-agent-palette" id="wf-agent-palette">
                        <div class="wf-palette-item" draggable="true" data-type="start">
                            <span class="wf-palette-icon"><svg viewBox="0 0 24 24" fill="currentColor"
                                    style="width:16px;height:16px;">
                                    <polygon points="5,3 19,12 5,21" />
                                </svg></span>
                            <span>Start</span>
                        </div>
                        <div class="wf-palette-item wf-palette-data" draggable="true" data-type="input">
                            <span class="wf-palette-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" style="width:18px;height:18px;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                    <polyline points="17 8 12 3 7 8" />
                                    <line x1="12" y1="3" x2="12" y2="15" />
                                </svg></span>
                            <span>Input</span>
                        </div>
                        <div class="wf-palette-item wf-palette-data" draggable="true" data-type="firestore">
                            <span class="wf-palette-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" style="width:18px;height:18px;">
                                    <ellipse cx="12" cy="5" rx="9" ry="3" />
                                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" />
                                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
                                </svg></span>
                            <span>Firestore</span>
                        </div>
                        <div class="wf-palette-item wf-palette-data" draggable="true" data-type="transform">
                            <span class="wf-palette-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" style="width:18px;height:18px;">
                                    <polyline points="16 3 21 3 21 8" />
                                    <line x1="4" y1="20" x2="21" y2="3" />
                                    <polyline points="21 16 21 21 16 21" />
                                    <line x1="15" y1="15" x2="21" y2="21" />
                                    <line x1="4" y1="4" x2="9" y2="9" />
                                </svg></span>
                            <span>Transform</span>
                        </div>
                        <div class="wf-palette-item" draggable="true" data-type="agent">
                            <span class="wf-palette-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" style="width:18px;height:18px;">
                                    <circle cx="12" cy="8" r="4" />
                                    <path d="M4 20v-2a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v2" />
                                </svg></span>
                            <span>Agent</span>
                        </div>
                        <div class="wf-palette-item" draggable="true" data-type="condition">
                            <span class="wf-palette-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" style="width:18px;height:18px;">
                                    <polyline points="9 11 12 14 22 4" />
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                                </svg></span>
                            <span>Condition</span>
                        </div>
                        <div class="wf-palette-item" draggable="true" data-type="parallel">
                            <span class="wf-palette-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" style="width:18px;height:18px;">
                                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                                </svg></span>
                            <span>Parallel</span>
                        </div>
                        <div class="wf-palette-item" draggable="true" data-type="end">
                            <span class="wf-palette-icon"><svg viewBox="0 0 24 24" fill="currentColor"
                                    style="width:14px;height:14px;">
                                    <rect x="4" y="4" width="16" height="16" />
                                </svg></span>
                            <span>End</span>
                        </div>
                    </div>
                </div>

                <!-- Properties Panel -->
                <aside class="wf-properties-panel" id="wf-properties-panel">
                    <div class="wf-properties-header">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                style="width:18px;height:18px;color:var(--wf-cyan);">
                                <path d="M12 20h9" />
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
                            </svg>
                            <h3>Node Properties</h3>
                        </div>
                    </div>
                    <div class="wf-properties-body" id="wf-properties-body">
                        <!-- No selection state -->
                        <div id="wf-no-selection" class="wf-no-selection">
                            <div class="wf-no-selection-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    style="width:48px;height:48px;opacity:0.3;">
                                    <path d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5" />
                                </svg>
                            </div>
                            <p>ÎÖ∏ÎìúÎ•º ÏÑ†ÌÉùÌïòÏó¨<br>ÏÜçÏÑ±ÏùÑ Ìé∏ÏßëÌïòÏÑ∏Ïöî</p>
                        </div>

                        <!-- Properties form (hidden by default) -->
                        <div id="wf-properties-form" style="display: none;">
                            <!-- Node Type -->
                            <div class="wf-property-group">
                                <label class="wf-property-label">Node Type</label>
                                <input type="text" id="wf-prop-type" class="wf-property-input" readonly>
                            </div>

                            <!-- Node Name -->
                            <div class="wf-property-group">
                                <label class="wf-property-label">Name</label>
                                <input type="text" id="wf-prop-name" class="wf-property-input" placeholder="Node name">
                            </div>

                            <!-- Agent Selector (for agent nodes) -->
                            <div class="wf-property-group" id="wf-prop-agent-group" style="display: none;">
                                <label class="wf-property-label">Agent</label>
                                <select id="wf-prop-agent" class="wf-property-select">
                                    <option value="">Select Agent...</option>
                                </select>
                            </div>

                            <!-- Model Selector -->
                            <div class="wf-property-group" id="wf-prop-model-group" style="display: none;">
                                <label class="wf-property-label"
                                    style="display: flex; align-items: center; justify-content: space-between;">
                                    <span>Model</span>
                                    <span id="wf-capability-badge" class="wf-capability-badge">üî§ TEXT</span>
                                </label>
                                <select id="wf-prop-model" class="wf-property-select">
                                    <optgroup label="üî§ Text Models">
                                        <option value="gpt-4o">‚≠ê GPT-4o (openai)</option>
                                        <option value="gpt-4o-mini">GPT-4o Mini (openai)</option>
                                        <option value="claude-3-5-sonnet">‚≠ê Claude 3.5 Sonnet (anthropic)</option>
                                        <option value="deepseek-reasoner">‚≠ê DeepSeek R1 (deepseek)</option>
                                        <option value="deepseek-chat">üí∞ DeepSeek Chat (deepseek)</option>
                                    </optgroup>
                                </select>
                                <p class="wf-property-hint">Agent's capability determines available models</p>
                            </div>

                            <!-- Temperature -->
                            <div class="wf-property-group" id="wf-prop-temp-group" style="display: none;">
                                <label class="wf-property-label">
                                    Temperature
                                    <span id="wf-prop-temp-value" class="wf-property-range-value">0.7</span>
                                </label>
                                <input type="range" id="wf-prop-temp" class="wf-property-range" min="0" max="1"
                                    step="0.1" value="0.7">
                            </div>

                            <!-- MCP Settings (Enhanced Tool-use) -->
                            <div class="wf-property-group" id="wf-prop-mcp-group" style="display: none;">
                                <div class="wf-mcp-header"
                                    style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                    <label class="wf-property-label" style="margin-bottom: 0;">üîå MCP Connection</label>
                                    <div class="wf-switch">
                                        <input type="checkbox" id="wf-prop-mcp-enabled"
                                            onchange="WorkflowCanvas.toggleMCP(this.checked)">
                                        <span class="wf-slider round"></span>
                                    </div>
                                </div>

                                <div id="wf-mcp-config"
                                    style="display: none; background: rgba(0, 0, 0, 0.3); padding: 12px; border-radius: 10px; border: 1px solid rgba(0, 240, 255, 0.1);">
                                    <div class="wf-property-subgroup" style="margin-bottom: 12px;">
                                        <label class="wf-property-label" style="font-size: 10px;">Select MCP
                                            Server</label>
                                        <select id="wf-prop-mcp-server" class="wf-property-select"
                                            style="padding: 8px 12px; font-size: 13px;"
                                            onchange="WorkflowCanvas.updateMCPServer(this.value)">
                                            <option value="">Choose Server...</option>
                                        </select>
                                    </div>

                                    <div id="wf-mcp-tools-container" style="display: none;">
                                        <label class="wf-property-label" style="font-size: 10px;">Enabled Tools</label>
                                        <div id="wf-mcp-tools-list" class="wf-mcp-tools-list"
                                            style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;">
                                            <!-- Filled by JS -->
                                        </div>
                                    </div>

                                    <div class="wf-property-subgroup">
                                        <label class="wf-property-label" style="font-size: 10px;">Context Mode</label>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="wf-mcp-mode-btn active" data-mode="hybrid"
                                                onclick="WorkflowCanvas.setMCPMode('hybrid')">Hybrid</button>
                                            <button class="wf-mcp-mode-btn" data-mode="tools-only"
                                                onclick="WorkflowCanvas.setMCPMode('tools-only')">Tools Only</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Condition Expression -->
                            <div class="wf-property-group" id="wf-prop-condition-group" style="display: none;">
                                <label class="wf-property-label">Condition Expression</label>
                                <textarea id="wf-prop-condition" class="wf-property-input wf-property-textarea"
                                    placeholder="e.g., output.score > 0.8"></textarea>

                                <!-- DEFAULT Policy -->
                                <div class="wf-default-policy" style="margin-top: 12px;">
                                    <label class="wf-property-label" style="font-size: 11px;">DEFAULT Í≤ΩÎ°ú Ïã§Ìñâ Ï°∞Í±¥</label>
                                    <div class="wf-checkbox-group">
                                        <label class="wf-checkbox-label">
                                            <input type="checkbox" id="wf-default-on-missing" checked>
                                            <span>ÌïÑÎìú ÎàÑÎùΩ Ïãú</span>
                                        </label>
                                        <label class="wf-checkbox-label">
                                            <input type="checkbox" id="wf-default-on-error" checked>
                                            <span>ÌèâÍ∞Ä Ïò§Î•ò Ïãú</span>
                                        </label>
                                        <label class="wf-checkbox-label">
                                            <input type="checkbox" id="wf-default-on-timeout" checked>
                                            <span>ÌÉÄÏûÑÏïÑÏõÉ Ïãú</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- INPUT NODE Settings -->
                            <div class="wf-property-group" id="wf-prop-input-node-group" style="display: none;">
                                <label class="wf-property-label">üì• Data Source (ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞)</label>
                                <select id="wf-prop-input-source" class="wf-property-select"
                                    onchange="WorkflowCanvas.updateInputSourceUI(this.value)">
                                    <option value="">Select Source...</option>
                                    <option value="knowledge_hub">Knowledge Hub Sources</option>
                                    <option value="project_brief">Project Brief</option>
                                    <option value="brand_brain">Brand Brain Context</option>
                                    <option value="firestore_query">Firestore Query</option>
                                    <option value="manual_json">Manual JSON Input</option>
                                </select>

                                <div id="wf-input-knowledge-options" class="wf-output-sub-options"
                                    style="display: none; margin-top: 10px;">
                                    <label class="wf-property-label" style="font-size: 11px;">Filter by Status</label>
                                    <select id="wf-prop-input-kh-status" class="wf-property-select"
                                        style="font-size: 12px;">
                                        <option value="active">Active Only (isActive: true)</option>
                                        <option value="completed">Completed Only</option>
                                        <option value="all">All Sources</option>
                                    </select>
                                </div>

                                <div id="wf-input-firestore-options" class="wf-output-sub-options"
                                    style="display: none; margin-top: 10px;">
                                    <label class="wf-property-label" style="font-size: 11px;">Collection Path</label>
                                    <input type="text" id="wf-prop-input-fs-collection" class="wf-property-input"
                                        placeholder="e.g., projects/{{projectId}}/knowledgeSources">
                                    <label class="wf-property-label" style="font-size: 11px; margin-top: 8px;">Where
                                        Clause (Optional)</label>
                                    <input type="text" id="wf-prop-input-fs-where" class="wf-property-input"
                                        placeholder="e.g., status == 'completed'">
                                </div>

                                <div id="wf-input-manual-options" class="wf-output-sub-options"
                                    style="display: none; margin-top: 10px;">
                                    <label class="wf-property-label" style="font-size: 11px;">JSON Data</label>
                                    <textarea id="wf-prop-input-manual-json"
                                        class="wf-property-input wf-property-textarea"
                                        placeholder='{"topic": "AI trends", "keywords": ["GPT", "Claude"]}'></textarea>
                                </div>
                            </div>

                            <!-- FIRESTORE NODE Settings -->
                            <div class="wf-property-group" id="wf-prop-firestore-group" style="display: none;">
                                <label class="wf-property-label">üî• Firestore Operation</label>
                                <select id="wf-prop-fs-operation" class="wf-property-select"
                                    onchange="WorkflowCanvas.updateFirestoreOpUI(this.value)">
                                    <option value="read">Read (Query)</option>
                                    <option value="write">Write (Add/Set)</option>
                                    <option value="update">Update (Merge)</option>
                                </select>

                                <label class="wf-property-label" style="margin-top: 12px;">Collection Path</label>
                                <input type="text" id="wf-prop-fs-collection" class="wf-property-input"
                                    placeholder="projects/{{projectId}}/brandSummaries">
                                <p class="wf-property-hint">Use {{variable}} for dynamic paths</p>

                                <div id="wf-fs-read-options" style="margin-top: 12px;">
                                    <label class="wf-property-label" style="font-size: 11px;">Where Clause</label>
                                    <input type="text" id="wf-prop-fs-where" class="wf-property-input"
                                        placeholder="status == 'active'">
                                    <label class="wf-property-label" style="font-size: 11px; margin-top: 8px;">Order
                                        By</label>
                                    <input type="text" id="wf-prop-fs-orderby" class="wf-property-input"
                                        placeholder="createdAt desc">
                                    <label class="wf-property-label"
                                        style="font-size: 11px; margin-top: 8px;">Limit</label>
                                    <input type="number" id="wf-prop-fs-limit" class="wf-property-input" value="50"
                                        min="1" max="500">
                                </div>

                                <div id="wf-fs-write-options" style="display: none; margin-top: 12px;">
                                    <label class="wf-property-label" style="font-size: 11px;">Document ID
                                        (Optional)</label>
                                    <input type="text" id="wf-prop-fs-docid" class="wf-property-input"
                                        placeholder="Leave blank for auto-ID">
                                    <label class="wf-property-label" style="font-size: 11px; margin-top: 8px;">Data
                                        Template</label>
                                    <textarea id="wf-prop-fs-write-template"
                                        class="wf-property-input wf-property-textarea"
                                        placeholder='{"title": "{{input.title}}", "content": "{{prev.output}}"}'></textarea>
                                </div>
                            </div>

                            <!-- TRANSFORM NODE Settings -->
                            <div class="wf-property-group" id="wf-prop-transform-group" style="display: none;">
                                <label class="wf-property-label">‚ö° Transform Operation</label>
                                <select id="wf-prop-transform-type" class="wf-property-select"
                                    onchange="WorkflowCanvas.updateTransformUI(this.value)">
                                    <option value="filter">Filter (Keep matching items)</option>
                                    <option value="map">Map (Transform each item)</option>
                                    <option value="reduce">Reduce (Aggregate to single value)</option>
                                    <option value="sort">Sort (Order items)</option>
                                    <option value="slice">Slice (First N items)</option>
                                    <option value="merge">Merge (Combine with context)</option>
                                </select>

                                <div id="wf-transform-filter-options" style="margin-top: 12px;">
                                    <label class="wf-property-label" style="font-size: 11px;">Filter Expression</label>
                                    <input type="text" id="wf-prop-transform-filter-expr" class="wf-property-input"
                                        placeholder="item.isActive === true && item.status === 'completed'">
                                    <p class="wf-property-hint">JavaScript expression. 'item' refers to each element.
                                    </p>
                                </div>

                                <div id="wf-transform-map-options" style="display: none; margin-top: 12px;">
                                    <label class="wf-property-label" style="font-size: 11px;">Map Template</label>
                                    <textarea id="wf-prop-transform-map-template"
                                        class="wf-property-input wf-property-textarea"
                                        placeholder='{ "id": item.id, "text": item.summary || item.content }'></textarea>
                                </div>

                                <div id="wf-transform-reduce-options" style="display: none; margin-top: 12px;">
                                    <label class="wf-property-label" style="font-size: 11px;">Reduce Expression</label>
                                    <input type="text" id="wf-prop-transform-reduce-expr" class="wf-property-input"
                                        placeholder="acc + item.wordCount">
                                    <label class="wf-property-label" style="font-size: 11px; margin-top: 8px;">Initial
                                        Value</label>
                                    <input type="text" id="wf-prop-transform-reduce-init" class="wf-property-input"
                                        placeholder="0">
                                </div>

                                <div id="wf-transform-sort-options" style="display: none; margin-top: 12px;">
                                    <label class="wf-property-label" style="font-size: 11px;">Sort Key</label>
                                    <input type="text" id="wf-prop-transform-sort-key" class="wf-property-input"
                                        placeholder="importance">
                                    <label class="wf-property-label"
                                        style="font-size: 11px; margin-top: 8px;">Order</label>
                                    <select id="wf-prop-transform-sort-order" class="wf-property-select"
                                        style="font-size: 12px;">
                                        <option value="desc">Descending (High ‚Üí Low)</option>
                                        <option value="asc">Ascending (Low ‚Üí High)</option>
                                    </select>
                                </div>

                                <div id="wf-transform-slice-options" style="display: none; margin-top: 12px;">
                                    <label class="wf-property-label" style="font-size: 11px;">Take First N Items</label>
                                    <input type="number" id="wf-prop-transform-slice-n" class="wf-property-input"
                                        value="10" min="1">
                                </div>

                                <div id="wf-transform-merge-options" style="display: none; margin-top: 12px;">
                                    <label class="wf-property-label" style="font-size: 11px;">Merge With</label>
                                    <select id="wf-prop-transform-merge-source" class="wf-property-select"
                                        style="font-size: 12px;">
                                        <option value="project_context">Project Context</option>
                                        <option value="brand_brain">Brand Brain</option>
                                        <option value="custom_json">Custom JSON</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Input Mapping -->
                            <div class="wf-property-group" id="wf-prop-input-group" style="display: none;">
                                <label class="wf-property-label">Input Mapping (Variable Binding)</label>
                                <textarea id="wf-prop-input-mapping" class="wf-property-input wf-property-textarea"
                                    placeholder='{"topic": "{{prev.output.topic}}"}'></textarea>

                                <div class="wf-variable-picker-container">
                                    <label class="wf-property-label" style="font-size: 11px; margin-top: 12px;">ÏÑ†Ìñâ ÎÖ∏Îìú Ï∂úÎ†•
                                        Í∞í (ÌÅ¥Î¶≠ÌïòÏó¨ ÏÇΩÏûÖ)</label>
                                    <div id="wf-variable-picker" class="wf-variable-picker">
                                        <!-- Filled by JS -->
                                    </div>
                                </div>
                            </div>

                            <!-- Output Settings (for END nodes) -->
                            <div class="wf-property-group" id="wf-prop-output-group" style="display: none;">
                                <label class="wf-property-label">Output Destination (Í≤∞Í≥º Ï†ÑÏÜ° ÎåÄÏÉÅ)</label>
                                <select id="wf-prop-output-dest" class="wf-property-select"
                                    onchange="WorkflowCanvas.updateOutputUI(this.value)">
                                    <option value="none">None (No auto-export)</option>
                                    <option value="studio">Studio Content (Ïä§ÌäúÎîîÏò§Î°ú Ï†ÑÏÜ°)</option>
                                    <option value="firestore">Firestore Collection (DB Ï†ÄÏû•)</option>
                                    <option value="webhook">External Webhook (Ïô∏Î∂Ä Ï†ÑÏÜ°)</option>
                                </select>

                                <!-- Studio Options -->
                                <div id="wf-output-studio-options" class="wf-output-sub-options"
                                    style="display: none; margin-top: 10px;">
                                    <label class="wf-property-label" style="font-size: 11px;">Pipeline Context</label>
                                    <input type="text" id="wf-prop-output-studio-context" class="wf-property-input"
                                        readonly>
                                    <p class="wf-property-hint">ÌòÑÏû¨ ÌååÏù¥ÌîÑÎùºÏù∏Ïùò Ïä§ÌäúÎîîÏò§ ÏÑ∏ÏÖòÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§.</p>
                                </div>

                                <!-- Firestore Options (Enhanced) -->
                                <div id="wf-output-firestore-options" class="wf-output-sub-options"
                                    style="display: none; margin-top: 10px;">
                                    <label class="wf-property-label" style="font-size: 11px;">Collection Path</label>
                                    <input type="text" id="wf-prop-output-collection" class="wf-property-input"
                                        placeholder="projects/{{projectId}}/brandSummaries">
                                    <p class="wf-property-hint">Use {{projectId}}, {{userId}}, {{timestamp}} for dynamic
                                        paths</p>

                                    <label class="wf-property-label" style="font-size: 11px; margin-top: 10px;">Document
                                        ID (Optional)</label>
                                    <input type="text" id="wf-prop-output-doc-id" class="wf-property-input"
                                        placeholder="Leave blank for auto-generated ID">

                                    <label class="wf-property-label" style="font-size: 11px; margin-top: 10px;">Data
                                        Template</label>
                                    <textarea id="wf-prop-output-data-template"
                                        class="wf-property-input wf-property-textarea"
                                        placeholder='{ "title": "Summary - {{timestamp}}", "content": "{{lastNode.output}}", "createdBy": "{{userId}}" }'></textarea>
                                    <p class="wf-property-hint">Map workflow output to Firestore document fields</p>
                                </div>

                                <!-- Webhook Options -->
                                <div id="wf-output-webhook-options" class="wf-output-sub-options"
                                    style="display: none; margin-top: 10px;">
                                    <label class="wf-property-label" style="font-size: 11px;">Webhook URL</label>
                                    <input type="url" id="wf-prop-output-webhook" class="wf-property-input"
                                        placeholder="https://api.example.com/endpoint">
                                </div>
                            </div>

                            <!-- Delete Button -->
                            <div class="wf-property-group"
                                style="margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--wf-border);">
                                <button class="wf-btn wf-btn-secondary"
                                    style="width: 100%; justify-content: center; color: var(--wf-red);"
                                    onclick="WorkflowCanvas.deleteSelectedNode()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        style="width:16px;height:16px;">
                                        <polyline points="3 6 5 6 21 6" />
                                        <path
                                            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                                        <line x1="10" y1="11" x2="10" y2="17" />
                                        <line x1="14" y1="11" x2="14" y2="17" />
                                    </svg>
                                    <span>Delete Node</span>
                                </button>
                            </div>
                        </div>

                        <!-- Trigger Settings (Workflow-level) -->
                        <div id="wf-trigger-settings" class="wf-trigger-settings">
                            <div class="wf-trigger-header">
                                <div style="display:flex;align-items:center;gap:10px;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        style="width:18px;height:18px;color:var(--wf-cyan);">
                                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                                    </svg>
                                    <h4 style="margin:0;">Trigger Settings</h4>
                                </div>
                            </div>
                            <div class="wf-property-group">
                                <label class="wf-property-label">Trigger Type</label>
                                <select id="wf-trigger-type" class="wf-property-select"
                                    onchange="WorkflowCanvas.updateTriggerType(this.value)">
                                    <option value="manual">Manual (ÏàòÎèô Ïã§Ìñâ)</option>
                                    <option value="schedule">Schedule (Ïä§ÏºÄÏ§Ñ)</option>
                                    <option value="firestore">Firestore Event</option>
                                    <option value="webhook">Webhook</option>
                                </select>
                            </div>

                            <!-- Schedule Options -->
                            <div id="wf-trigger-schedule-options" class="wf-trigger-options" style="display: none;">
                                <div class="wf-property-group">
                                    <label class="wf-property-label">Cron Expression</label>
                                    <input type="text" id="wf-trigger-cron" class="wf-property-input"
                                        placeholder="0 9 * * *">
                                    <p class="wf-property-hint">Ïòà: "0 9 * * *" = Îß§Ïùº Ïò§Ï†Ñ 9Ïãú</p>
                                </div>
                                <div class="wf-property-group">
                                    <label class="wf-property-label">Timezone</label>
                                    <select id="wf-trigger-timezone" class="wf-property-select">
                                        <option value="Asia/Seoul">Asia/Seoul (KST)</option>
                                        <option value="UTC">UTC</option>
                                        <option value="America/New_York">America/New_York (EST)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Firestore Options -->
                            <div id="wf-trigger-firestore-options" class="wf-trigger-options" style="display: none;">
                                <div class="wf-property-group">
                                    <label class="wf-property-label">Collection Path</label>
                                    <input type="text" id="wf-trigger-collection" class="wf-property-input"
                                        placeholder="posts/{postId}">
                                </div>
                                <div class="wf-property-group">
                                    <label class="wf-property-label">Event Type</label>
                                    <select id="wf-trigger-event" class="wf-property-select">
                                        <option value="onCreate">onCreate</option>
                                        <option value="onUpdate">onUpdate</option>
                                        <option value="onDelete">onDelete</option>
                                        <option value="onWrite">onWrite (Any)</option>
                                    </select>
                                </div>
                                <div class="wf-property-group">
                                    <label class="wf-property-label">Field Condition (Optional)</label>
                                    <input type="text" id="wf-trigger-field-condition" class="wf-property-input"
                                        placeholder="commentCount >= 10">
                                </div>
                            </div>

                            <!-- Webhook Options -->
                            <div id="wf-trigger-webhook-options" class="wf-trigger-options" style="display: none;">
                                <div class="wf-property-group">
                                    <label class="wf-property-label">Webhook URL</label>
                                    <input type="text" id="wf-trigger-webhook-url" class="wf-property-input" readonly
                                        placeholder="Auto-generated">
                                    <button class="wf-btn wf-btn-secondary" style="margin-top: 8px; font-size: 11px;"
                                        onclick="WorkflowCanvas.generateWebhookUrl()">
                                        üîó Generate URL
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- Step 3: Code Preview -->
        <div id="wf-step-3" class="wf-step-content">
            <div class="wf-code-container">
                <!-- JSON Definition -->
                <div class="wf-code-panel">
                    <div class="wf-code-panel-header">
                        <h4>üìÑ Workflow Definition (JSON)</h4>
                        <button class="wf-code-copy-btn" onclick="WorkflowCanvas.copyJSON()">
                            üìã Copy
                        </button>
                    </div>
                    <div class="wf-code-content">
                        <pre id="wf-json-output"><code>// Generate workflow on Canvas first</code></pre>
                    </div>
                </div>

                <!-- Execution Code -->
                <div class="wf-code-panel">
                    <div class="wf-code-panel-header">
                        <h4>‚ö° Execution Code (JavaScript)</h4>
                        <button class="wf-code-copy-btn" onclick="WorkflowCanvas.copyJS()">
                            üìã Copy
                        </button>
                    </div>
                    <div class="wf-code-content">
                        <pre id="wf-js-output"><code>// Generate workflow on Canvas first</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>