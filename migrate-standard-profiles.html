<!DOCTYPE html>
<html>

<head>
    <title>Migrate Standard Profiles to Agent Registry</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        body {
            background: #0a0a0a;
            color: #fff;
            font-family: system-ui;
            padding: 40px;
        }

        h1 {
            color: #4ecdc4;
        }

        button {
            background: #16e0bd;
            color: #000;
            border: none;
            padding: 16px 32px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 8px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: #0fc9a7;
        }

        button.danger {
            background: #ef4444;
            color: #fff;
        }

        button.danger:hover {
            background: #dc2626;
        }

        #log {
            background: #1a1a1a;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }

        .success {
            color: #22c55e;
        }

        .warning {
            color: #f59e0b;
        }

        .error {
            color: #ef4444;
        }

        .info {
            color: #3b82f6;
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            background: #1a1a1a;
            color: #4ecdc4;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .badge-new {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .badge-update {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
    </style>
</head>

<body>
    <h1>ğŸ”„ Standard Profiles â†’ Agent Registry ë§ˆì´ê·¸ë ˆì´ì…˜</h1>
    <p>Settingsì— ì €ì¥ëœ ìƒì„¸ í”„ë¡¬í”„íŠ¸ë¥¼ Agent Registryë¡œ ì´ì „í•©ë‹ˆë‹¤.</p>

    <div>
        <button onclick="analyzeData()">1ï¸âƒ£ ë°ì´í„° ë¶„ì„</button>
        <button onclick="runMigration()">2ï¸âƒ£ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰</button>
        <button class="danger" onclick="showDeleteModal()">3ï¸âƒ£ ë ˆê±°ì‹œ ë°ì´í„° ì‚­ì œ (ì„ íƒ)</button>
    </div>

    <!-- Custom Delete Confirmation Modal -->
    <div id="delete-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div
            style="background: #1a1a1a; padding: 32px; border-radius: 12px; max-width: 500px; border: 2px solid #ef4444;">
            <h3 style="color: #ef4444; margin: 0 0 16px 0;">âš ï¸ ë ˆê±°ì‹œ ë°ì´í„° ì‚­ì œ í™•ì¸</h3>
            <p style="color: #fff; margin-bottom: 16px;">
                <strong>systemSettings/standardAgentProfiles</strong> ë¬¸ì„œë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.<br><br>
                ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </p>
            <p style="color: #f59e0b; margin-bottom: 16px;">
                ì‚­ì œí•˜ë ¤ë©´ ì•„ë˜ì— <strong>"DELETE"</strong>ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”:
            </p>
            <input type="text" id="delete-confirm-input"
                style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #333; background: #0a0a0a; color: #fff; border-radius: 8px; margin-bottom: 20px;"
                placeholder="DELETE ì…ë ¥">
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="hideDeleteModal()" style="background: #333; color: #fff;">ì·¨ì†Œ</button>
                <button onclick="executeDelete()" class="danger">ğŸ—‘ï¸ ì‚­ì œ ì‹¤í–‰</button>
            </div>
        </div>
    </div>

    <div id="comparison"></div>
    <div id="log">ëŒ€ê¸° ì¤‘...</div>

    <script>
        function log(msg, type = 'info') {
            const logEl = document.getElementById('log');
            const className = type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'error' ? 'error' : 'info';
            logEl.innerHTML += `<span class="${className}">${msg}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Analyze data from both sources
        async function analyzeData() {
            clearLog();
            log('ğŸ” ë°ì´í„° ë¶„ì„ ì‹œì‘...');

            const db = firebase.firestore();

            try {
                // 1. Load legacy data
                log('\nğŸ“‚ [ì†ŒìŠ¤ 1] systemSettings/standardAgentProfiles ë¡œë”©...');
                const legacyDoc = await db.collection('systemSettings').doc('standardAgentProfiles').get();
                const legacyAgents = legacyDoc.exists ? (legacyDoc.data().agents || {}) : {};
                log(`   â†’ ${Object.keys(legacyAgents).length}ê°œ ì—ì´ì „íŠ¸ ë°œê²¬`, 'success');

                // 2. Load registry data
                log('\nğŸ“‚ [ì†ŒìŠ¤ 2] agentRegistry ë¡œë”©...');
                const registrySnap = await db.collection('agentRegistry').get();
                const registryAgents = {};
                registrySnap.forEach(doc => {
                    registryAgents[doc.id] = doc.data();
                });
                log(`   â†’ ${Object.keys(registryAgents).length}ê°œ ì—ì´ì „íŠ¸ ë°œê²¬`, 'success');

                // 3. Compare
                log('\nğŸ“Š ë¹„êµ ë¶„ì„:');
                const allAgentIds = new Set([...Object.keys(legacyAgents), ...Object.keys(registryAgents)]);

                let html = '<table><tr><th>Agent ID</th><th>Legacy (Settings)</th><th>Registry</th><th>Prompt ê¸¸ì´ ë¹„êµ</th><th>Action</th></tr>';

                allAgentIds.forEach(id => {
                    const legacy = legacyAgents[id];
                    const registry = registryAgents[id];

                    const legacyPromptLen = legacy?.systemPrompt?.length || 0;
                    const registryExists = !!registry;

                    let action = '';
                    let actionBadge = '';

                    if (legacy && !registry) {
                        action = 'ìƒˆë¡œ ìƒì„± í•„ìš”';
                        actionBadge = '<span class="badge badge-new">NEW</span>';
                    } else if (legacy && registry && legacyPromptLen > 500) {
                        action = 'ìƒì„¸ í”„ë¡¬í”„íŠ¸ ì—…ë°ì´íŠ¸';
                        actionBadge = '<span class="badge badge-update">UPDATE</span>';
                    } else if (!legacy && registry) {
                        action = 'ì´ë¯¸ Registryì—ë§Œ ì¡´ì¬';
                        actionBadge = '-';
                    } else {
                        action = '-';
                        actionBadge = '-';
                    }

                    html += `<tr>
                        <td><strong>${id}</strong></td>
                        <td>${legacy ? `âœ… ${legacy.displayName || id}` : 'âŒ ì—†ìŒ'}</td>
                        <td>${registry ? `âœ… ${registry.name || id}` : 'âŒ ì—†ìŒ'}</td>
                        <td>${legacyPromptLen > 0 ? `${legacyPromptLen} chars` : '-'}</td>
                        <td>${actionBadge} ${action}</td>
                    </tr>`;
                });

                html += '</table>';
                document.getElementById('comparison').innerHTML = html;

                log('\nâœ… ë¶„ì„ ì™„ë£Œ! ìœ„ í…Œì´ë¸”ì„ í™•ì¸ í›„ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ì„¸ìš”.', 'success');

            } catch (error) {
                log('âŒ ë¶„ì„ ì˜¤ë¥˜: ' + error.message, 'error');
                console.error(error);
            }
        }

        // Run migration
        async function runMigration() {
            clearLog();
            log('ğŸš€ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...');

            const db = firebase.firestore();
            const ts = firebase.firestore.FieldValue.serverTimestamp();

            try {
                // Load legacy data
                const legacyDoc = await db.collection('systemSettings').doc('standardAgentProfiles').get();
                if (!legacyDoc.exists || !legacyDoc.data().agents) {
                    log('âš ï¸ Legacy ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }

                const legacyAgents = legacyDoc.data().agents;
                log(`ğŸ“¦ ${Object.keys(legacyAgents).length}ê°œ ì—ì´ì „íŠ¸ ì²˜ë¦¬ ì¤‘...`);

                // Category mapping based on agent ID patterns
                const categoryMap = {
                    'research': 'Intelligence',
                    'seo_watcher': 'Intelligence',
                    'knowledge_curator': 'Intelligence',
                    'planner': 'Strategy',
                    'creator_text': 'Design',
                    'creator_image': 'Design',
                    'creator_video': 'Design',
                    'compliance': 'QA',
                    'evaluator': 'QA',
                    'publisher': 'Studio',
                    'manager': 'Management',
                    'router': 'Management',
                    'kpi': 'Intelligence',
                    'engagement': 'Growth'
                };

                const batch = db.batch();
                let updateCount = 0;

                for (const [agentId, agentData] of Object.entries(legacyAgents)) {
                    const displayName = agentData.displayName || agentId;
                    const category = categoryMap[agentId] || 'Other';
                    const systemPrompt = agentData.systemPrompt || '';
                    const temperature = agentData.temperature || 0.7;

                    if (!systemPrompt || systemPrompt.length < 50) {
                        log(`   â­ï¸ ${agentId}: í”„ë¡¬í”„íŠ¸ê°€ ë„ˆë¬´ ì§§ì•„ ìŠ¤í‚µ (${systemPrompt.length} chars)`, 'warning');
                        continue;
                    }

                    log(`   ğŸ“¦ ${agentId}: ${displayName} (${systemPrompt.length} chars)`);

                    // 1. Update or Create Registry Entry
                    const regRef = db.collection('agentRegistry').doc(agentId);
                    batch.set(regRef, {
                        id: agentId,
                        name: displayName,
                        category: category,
                        description: `Migrated from Standard Agent Profiles`,
                        status: agentData.isEnabled !== false ? 'active' : 'inactive',
                        currentProductionVersion: '1.0.0',
                        sourceFiles: ['services/agent-execution-service.js'],
                        updatedAt: ts
                    }, { merge: true });

                    // 2. Update or Create Production Version with DETAILED PROMPT
                    const verRef = db.collection('agentVersions').doc(`${agentId}-v1-0-0`);
                    batch.set(verRef, {
                        agentId: agentId,
                        version: '1.0.0',
                        status: 'production',
                        isProduction: true,
                        systemPrompt: systemPrompt,  // THE DETAILED PROMPT
                        config: {
                            model: agentData.model || 'deepseek-chat',
                            temperature: temperature
                        },
                        procedures: [
                            { step: 1, action: 'init', label: 'Initialize', description: 'Setup context and role' },
                            { step: 2, action: 'execute', label: 'Execute Task', description: displayName },
                            { step: 3, action: 'finalize', label: 'Finalize Output', description: 'Clean and format result' }
                        ],
                        changelog: 'Migrated from Settings > Standard Agent Profiles (with detailed prompts)',
                        createdAt: ts
                    }, { merge: true });

                    updateCount++;
                }

                await batch.commit();
                log(`\nâœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ! ${updateCount}ê°œ ì—ì´ì „íŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                log('\nğŸ‘‰ admin-registry.html í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìƒì„¸ í”„ë¡¬í”„íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”!', 'success');

            } catch (error) {
                log('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜: ' + error.message, 'error');
                console.error(error);
            }
        }

        // Show custom delete modal
        function showDeleteModal() {
            const modal = document.getElementById('delete-modal');
            modal.style.display = 'flex';
            document.getElementById('delete-confirm-input').value = '';
            document.getElementById('delete-confirm-input').focus();
        }

        // Hide custom delete modal
        function hideDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
        }

        // Execute delete after confirmation
        async function executeDelete() {
            const inputValue = document.getElementById('delete-confirm-input').value.trim();

            if (inputValue !== 'DELETE') {
                alert('âŒ "DELETE"ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            hideDeleteModal();
            clearLog();
            log('ğŸ—‘ï¸ ë ˆê±°ì‹œ ë°ì´í„° ì‚­ì œ ì¤‘...');

            try {
                const db = firebase.firestore();
                await db.collection('systemSettings').doc('standardAgentProfiles').delete();
                log('âœ… systemSettings/standardAgentProfiles ì‚­ì œ ì™„ë£Œ!', 'success');
                log('\nì´ì œ Agent Registryê°€ ìœ ì¼í•œ ë°ì´í„° ì†ŒìŠ¤ì…ë‹ˆë‹¤.', 'info');
            } catch (error) {
                log('âŒ ì‚­ì œ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }
    </script>
</body>

</html>