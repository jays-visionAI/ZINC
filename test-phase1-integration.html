<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Phase 1 Integration Test</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="firebase-config.js"></script>
    <script src="utils-runtime-resolver.js"></script>
    <script src="utils-brand-brain.js"></script>
    <style>
        body {
            background: #1a1a1a;
            color: #fff;
            font-family: monospace;
            padding: 20px;
        }

        .success {
            color: #22c55e;
        }

        .error {
            color: #ef4444;
        }

        .info {
            color: #3b82f6;
        }

        pre {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>Phase 1 Integration Test</h1>
    <div id="logs"></div>
    <div id="test-done" style="display:none;">DONE</div>

    <script>
        const logs = document.getElementById('logs');
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.appendChild(div);
            console.log(msg);
        }

        async function runTest() {
            try {
                log('Starting Phase 1 Integration Test...', 'info');

                // 1. Mock Data Setup
                const mockTemplate = {
                    id: 'tpl_test_planner',
                    type: 'planner',
                    engineTypeId: 'planner',
                    roleTypeForRuntime: 'strategist',
                    primaryLanguage: 'ko',
                    preferredTier: 'balanced',
                    requiresBrandBrain: true,
                    brandContextMode: 'light',
                    config: { temperature: 0.7 }
                };

                const mockInstance = {
                    id: 'sa_test_001',
                    runtimeRuleOverrideId: null // No override initially
                };

                const projectId = 'proj_test_123';
                const taskPrompt = "Plan a marketing campaign for Q4.";

                log('--- Step 1: Runtime Resolution (Standard) ---', 'info');
                const config1 = await window.resolveRuntimeConfig(mockTemplate, mockInstance);
                log(`Resolved Config: Model=${config1.model_id}, Temp=${config1.temperature}, Lang=${config1.language}`, 'success');

                if (config1.language !== 'ko') throw new Error('Language resolution failed');
                if (config1.tier !== 'balanced') throw new Error('Tier resolution failed');

                log('--- Step 2: Runtime Resolution (Instance Override) ---', 'info');
                // Mock an override - we can't easily mock Firestore here without writing to it, 
                // so we'll skip the actual DB call verification for override unless we write a rule.
                // But we can verify the logic handles the ID.
                mockInstance.runtimeRuleOverrideId = 'rule_creative_chaos_v1';
                // Note: This will likely fallback to engine default in this test env if rule doesn't exist,
                // but we want to see the log that it TRIED to use the override.
                const config2 = await window.resolveRuntimeConfig(mockTemplate, mockInstance);
                log(`Resolved Config (Override Attempt): Source=${config2.resolution_source}`, 'success');

                log('--- Step 3: Brand Brain Context ---', 'info');
                if (mockTemplate.requiresBrandBrain) {
                    const contexts = await window.queryBrandBrain(projectId, taskPrompt, {
                        mode: mockTemplate.brandContextMode
                    });
                    log(`Retrieved ${contexts.length} context snippets from Brand Brain`, 'success');

                    const enrichedPrompt = window.enrichSystemPromptWithBrandContext("You are a planner.", contexts);
                    log('Enriched Prompt Preview:', 'info');
                    const preview = enrichedPrompt.split('\n').slice(-5).join('\n'); // Last 5 lines
                    logs.innerHTML += `<pre>${preview}</pre>`;

                    if (!enrichedPrompt.includes('Brand Context')) throw new Error('Prompt enrichment failed');
                }

                log('✅ Phase 1 Integration Test Passed!', 'success');

            } catch (e) {
                log(`❌ Test Failed: ${e.message}`, 'error');
                console.error(e);
            } finally {
                document.getElementById('test-done').style.display = 'block';
            }
        }

        // Wait for scripts to load
        setTimeout(runTest, 1000);
    </script>
</body>

</html>