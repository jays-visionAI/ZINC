<div class="admin-card">
    <div style="margin-bottom: 24px;">
        <h3 style="margin: 0; display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 24px;">ğŸ¤–</span>
            AI Chatbot Settings
        </h3>
        <p style="margin: 4px 0 0 0; color: rgba(255,255,255,0.5); font-size: 14px;">
            Configure the AI helpdesk chatbot settings and knowledge base.
        </p>
    </div>

    <!-- Tab Navigation (matching Settings page style) -->
    <div id="chatbot-tabs"
        style="display: flex; gap: 32px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 24px;">
        <div class="chatbot-tab active" data-tab="general" id="tab-btn-general"
            style="padding-bottom: 12px; cursor: pointer; border-bottom: 2px solid #16e0bd; color: #fff; font-weight: 600;">
            General</div>
        <div class="chatbot-tab" data-tab="page-context" id="tab-btn-page-context"
            style="padding-bottom: 12px; cursor: pointer; border-bottom: 2px solid transparent; color: rgba(255,255,255,0.5);">
            Page Context</div>
        <div class="chatbot-tab" data-tab="voice" id="tab-btn-voice"
            style="padding-bottom: 12px; cursor: pointer; border-bottom: 2px solid transparent; color: rgba(255,255,255,0.5);">
            Voice Settings</div>
    </div>

    <!-- General Settings Tab -->
    <div id="tab-general" class="tab-content">

        <!-- System Prompt Section -->
        <div
            style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 24px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 24px;">
            <h4 style="margin: 0 0 16px 0; color: #fff; display: flex; align-items: center; gap: 8px;">
                <span>ğŸ“</span> System Prompt
            </h4>
            <p style="font-size: 12px; color: rgba(255,255,255,0.4); margin-bottom: 12px;">
                Define the AI's role, capabilities, and restrictions. This prompt is sent with every request.
            </p>
            <textarea id="chatbot-system-prompt" class="admin-input"
                style="width: 100%; height: 200px; resize: vertical; font-family: monospace; font-size: 13px;"
                placeholder="Enter system prompt...">ë‹¹ì‹ ì€ ZYNK í—¬í”„ë°ìŠ¤í¬ AIì…ë‹ˆë‹¤.

## ì—­í• 
- ZYNK í”Œë«í¼ ì‚¬ìš©ë²• ì•ˆë‚´
- ê¸°ëŠ¥ ì„¤ëª… (Market Pulse, Brand Brain, Studio, The Filter, The Growth)
- ë¬¸ì œ í•´ê²° ë° íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

## ì œí•œì‚¬í•­
ZYNKì™€ ê´€ë ¨ëœ ì§ˆë¬¸ì—ë§Œ ë‹µë³€í•˜ì„¸ìš”.
ë‹¤ìŒê³¼ ê°™ì€ ìš”ì²­ì€ ì •ì¤‘íˆ ê±°ì ˆí•˜ì„¸ìš”:
- ìˆ˜í•™ ë¬¸ì œ í’€ì´
- ë²ˆì—­ ìš”ì²­
- ë‰´ìŠ¤/ê¸°ì‚¬ ê²€ìƒ‰
- ì½”ë“œ ì‘ì„±

## ê±°ì ˆ ì‘ë‹µ
"ì£„ì†¡í•©ë‹ˆë‹¤. ì €ëŠ” ZYNK ì‚¬ìš©ì— ê´€í•œ ì§ˆë¬¸ë§Œ ë„ì™€ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ"</textarea>
        </div>

        <!-- Welcome Message Section -->
        <div
            style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 24px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 24px;">
            <h4 style="margin: 0 0 16px 0; color: #fff; display: flex; align-items: center; gap: 8px;">
                <span>ğŸ‘‹</span> Welcome Message
            </h4>
            <p style="font-size: 12px; color: rgba(255,255,255,0.4); margin-bottom: 12px;">
                The first message users see when opening the chatbot.
            </p>
            <textarea id="chatbot-welcome-message" class="admin-input"
                style="width: 100%; height: 100px; resize: vertical; font-size: 13px;"
                placeholder="Enter welcome message...">ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ZYNK í—¬í”„ë°ìŠ¤í¬ AIì…ë‹ˆë‹¤. ğŸ

ZYNK ì‚¬ìš©ì— ê´€í•œ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ í¸í•˜ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!

ğŸ”¹ ê¸°ëŠ¥ ì‚¬ìš©ë²•
ğŸ”¹ ë¬¸ì œ í•´ê²°
ğŸ”¹ íŒê³¼ ê°€ì´ë“œ</textarea>
        </div>

        <!-- Settings Section -->
        <div
            style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 24px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 24px;">
            <h4 style="margin: 0 0 16px 0; color: #fff; display: flex; align-items: center; gap: 8px;">
                <span>âš™ï¸</span> Settings
            </h4>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div>
                    <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #ccc;">Daily Limit (per
                        user)</label>
                    <input type="number" id="chatbot-daily-limit" class="admin-input" value="50" min="1" max="1000"
                        style="width: 100px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #ccc;">Chatbot
                        Status</label>
                    <select id="chatbot-status" class="admin-input" style="width: 150px;">
                        <option value="active">Active</option>
                        <option value="disabled">Disabled</option>
                        <option value="maintenance">Maintenance</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- FAQ Section -->
        <div
            style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 24px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h4 style="margin: 0; color: #fff; display: flex; align-items: center; gap: 8px;">
                    <span>â“</span> FAQ (Quick Answers)
                </h4>
                <button id="btn-add-faq" class="admin-btn-primary" style="padding: 8px 16px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="vertical-align: middle; margin-right: 4px;">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add FAQ
                </button>
            </div>
            <p style="font-size: 12px; color: rgba(255,255,255,0.4); margin-bottom: 16px;">
                Pre-defined questions and answers for common queries.
            </p>

            <div id="faq-list" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- FAQ items will be rendered here -->
            </div>
        </div>

        <!-- Save Button -->
        <div style="display: flex; justify-content: flex-end; gap: 12px;">
            <button id="btn-reset-chatbot" class="admin-btn-secondary" style="padding: 12px 24px;">
                Reset to Defaults
            </button>
            <button id="btn-save-chatbot" class="admin-btn-primary" style="padding: 12px 32px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    style="vertical-align: middle; margin-right: 6px;">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Save Settings
            </button>
        </div>
    </div> <!-- End of General Tab -->

    <!-- Page Context Tab -->
    <div id="tab-page-context" class="tab-content" style="display: none;">
        <div
            style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 24px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div>
                    <h4 style="margin: 0 0 8px 0; color: #fff; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ“„</span> Page Context Management
                    </h4>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.4); margin: 0;">
                        Configure help text and tips for each page. The chatbot uses this to provide context-aware
                        assistance.
                    </p>
                </div>
                <button id="btn-refresh-pages" class="admin-btn-secondary" style="padding: 8px 16px;">
                    ğŸ”„ Refresh
                </button>
            </div>

            <!-- Page Selector -->
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #ccc;">Select Page</label>
                <select id="page-context-select" class="admin-input" style="width: 100%; max-width: 300px;">
                    <option value="">-- Select a page --</option>
                </select>
            </div>

            <!-- Page Context Editor (shown when page selected) -->
            <div id="page-context-editor" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #ccc;">Name
                            (EN)</label>
                        <input type="text" id="ctx-name-en" class="admin-input" placeholder="e.g. Brand Brain">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #ccc;">Name
                            (KO)</label>
                        <input type="text" id="ctx-name-ko" class="admin-input" placeholder="ì˜ˆ: ë¸Œëœë“œ ë¸Œë ˆì¸">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #ccc;">Description
                            (EN)</label>
                        <textarea id="ctx-desc-en" class="admin-input" style="height: 80px;"
                            placeholder="Describe what this page does..."></textarea>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #ccc;">Description
                            (KO)</label>
                        <textarea id="ctx-desc-ko" class="admin-input" style="height: 80px;"
                            placeholder="ì´ í˜ì´ì§€ì˜ ê¸°ëŠ¥ì„ ì„¤ëª…í•˜ì„¸ìš”..."></textarea>
                    </div>
                </div>

                <!-- Tips Section -->
                <div style="margin-bottom: 16px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <label style="font-size: 13px; color: #ccc; font-weight: 600;">ğŸ’¡ Help Tips</label>
                        <button type="button" id="btn-add-tip" class="admin-btn-secondary"
                            style="padding: 6px 12px; font-size: 12px;">+ Add Tip</button>
                    </div>
                    <div id="tips-container" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Tips will be populated here -->
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="ctx-is-active" checked style="width: 18px; height: 18px;">
                        <span style="color: #ccc; font-size: 13px;">Page is Active</span>
                    </label>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 12px;">
                    <button id="btn-save-page-context" class="admin-btn-primary" style="padding: 12px 24px;">
                        ğŸ’¾ Save Page Context
                    </button>
                </div>
            </div>
        </div>
    </div> <!-- End of Page Context Tab -->

    <!-- Voice Settings Tab -->
    <div id="tab-voice" class="tab-content" style="display: none;">
        <div
            style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 24px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 24px;">
            <h4 style="margin: 0 0 16px 0; color: #fff; display: flex; align-items: center; gap: 8px;">
                <span>ğŸ¤</span> Voice Settings
            </h4>
            <p style="font-size: 12px; color: rgba(255,255,255,0.4); margin-bottom: 16px;">
                Configure voice input (speech-to-text) and output (text-to-speech) for the chatbot.
            </p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                <div
                    style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 16px;">
                    <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                        <div>
                            <div style="font-weight: 600; color: #e2e8f0; margin-bottom: 4px;">ğŸ¤ Voice Input (STT)
                            </div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.4);">Allow users to speak their
                                questions</div>
                        </div>
                        <input type="checkbox" id="voice-input-enabled" style="width: 24px; height: 24px;">
                    </label>
                </div>

                <div
                    style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 16px;">
                    <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                        <div>
                            <div style="font-weight: 600; color: #e2e8f0; margin-bottom: 4px;">ğŸ”Š Voice Output (TTS)
                            </div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.4);">Read bot responses aloud</div>
                        </div>
                        <input type="checkbox" id="voice-output-enabled" style="width: 24px; height: 24px;">
                    </label>
                </div>
            </div>

            <div
                style="margin-top: 16px; padding: 12px; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px;">
                <div style="font-size: 12px; color: #a5b4fc;">
                    â„¹ï¸ Voice features use the browser's built-in Web Speech API. Supported in Chrome, Edge, and Safari.
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px;">
                <button id="btn-save-voice" class="admin-btn-primary" style="padding: 12px 24px;">
                    ğŸ’¾ Save Voice Settings
                </button>
            </div>
        </div>
    </div> <!-- End of Voice Tab -->


    <!-- Add/Edit FAQ Modal -->
    <div id="faq-modal" class="modal-overlay" style="display: none;">
        <div class="modal-container" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="faq-modal-title">Add FAQ</h3>
                <button class="modal-close" onclick="closeFaqModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="faq-edit-id">

                <div class="form-group">
                    <label>Question</label>
                    <input type="text" id="faq-question" class="admin-input" placeholder="e.g. Market Pulseê°€ ë­”ê°€ìš”?"
                        required>
                </div>

                <div class="form-group">
                    <label>Answer</label>
                    <textarea id="faq-answer" class="admin-input" style="height: 150px; resize: vertical;"
                        placeholder="Enter the answer..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="admin-btn-secondary" onclick="closeFaqModal()">Cancel</button>
                <button class="admin-btn-primary" id="btn-save-faq">Save FAQ</button>
            </div>
        </div>
    </div>

    <style>
        /* Modal Styles (reuse from settings) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-container {
            background: #1e1e24;
            border: 1px solid #333;
            border-radius: 8px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #333;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #ccc;
        }

        .admin-input {
            width: 100%;
            padding: 8px 12px;
            background: #2a2a30;
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            font-size: 14px;
        }

        .admin-input:focus {
            border-color: #16e0bd;
            outline: none;
        }

        .faq-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 16px;
        }

        .faq-item:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .faq-question {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 8px;
        }

        .faq-answer {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            white-space: pre-wrap;
        }

        .faq-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        /* Resizable Textarea Styles */
        textarea.admin-input {
            resize: vertical;
            min-height: 80px;
            position: relative;
        }

        /* Custom resize handle - visible gripper */
        textarea.admin-input::-webkit-resizer {
            background: linear-gradient(135deg, transparent 60%, #16e0bd 60%, #16e0bd 70%, transparent 70%),
                linear-gradient(135deg, transparent 70%, #16e0bd 70%, #16e0bd 80%, transparent 80%),
                linear-gradient(135deg, transparent 80%, #16e0bd 80%, #16e0bd 90%, transparent 90%);
            cursor: ns-resize;
        }

        /* Firefox resize styling */
        textarea.admin-input {
            scrollbar-color: #16e0bd #2a2a30;
        }

        /* Wrapper for resize indicator */
        .textarea-wrapper {
            position: relative;
        }

        .textarea-wrapper::after {
            content: 'â‹®â‹®';
            position: absolute;
            bottom: 4px;
            right: 8px;
            color: #16e0bd;
            font-size: 10px;
            letter-spacing: 2px;
            pointer-events: none;
            opacity: 0.7;
        }
    </style>

    <script>
        // Textarea height persistence via localStorage
        function initTextareaResize() {
            const textareas = document.querySelectorAll('textarea.admin-input[id]');

            textareas.forEach(textarea => {
                const storageKey = `textarea_height_${textarea.id}`;

                // Restore saved height
                const savedHeight = localStorage.getItem(storageKey);
                if (savedHeight) {
                    textarea.style.height = savedHeight;
                }

                // Save height on resize using ResizeObserver
                const resizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        const height = entry.target.style.height || entry.target.offsetHeight + 'px';
                        localStorage.setItem(storageKey, height);
                    }
                });

                resizeObserver.observe(textarea);
            });
        }

        // Run after DOM is ready
        document.addEventListener('DOMContentLoaded', initTextareaResize);

        // Also run immediately in case DOM is already loaded
        if (document.readyState !== 'loading') {
            initTextareaResize();
        }

        // Auto-initialize Chatbot settings when loaded
        if (typeof window.initChatbot === 'function') {
            console.log('[Chatbot Settings] Auto-initializing...');
            window.initChatbot();
        } else if (typeof window.initChatbotSettings === 'function') {
            console.log('[Chatbot Settings] Auto-initializing (legacy)...');
            window.initChatbotSettings();
        }

        // ============================================
        // TAB SWITCHING
        // ============================================

        function initChatbotTabs() {
            const tabs = document.querySelectorAll('.chatbot-tab');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;

                    // Update tab styles (underline style)
                    tabs.forEach(t => {
                        t.style.borderBottom = '2px solid transparent';
                        t.style.color = 'rgba(255,255,255,0.5)';
                        t.style.fontWeight = '400';
                        t.classList.remove('active');
                    });

                    tab.style.borderBottom = '2px solid #16e0bd';
                    tab.style.color = '#fff';
                    tab.style.fontWeight = '600';
                    tab.classList.add('active');

                    // Show/hide content
                    document.getElementById('tab-general').style.display = targetTab === 'general' ? 'block' : 'none';
                    document.getElementById('tab-page-context').style.display = targetTab === 'page-context' ? 'block' : 'none';
                    document.getElementById('tab-voice').style.display = targetTab === 'voice' ? 'block' : 'none';

                    // Initialize tab content
                    if (targetTab === 'page-context') {
                        loadPageContextList();
                    } else if (targetTab === 'voice') {
                        loadVoiceSettings();
                    }
                });
            });
        }

        // ============================================
        // PAGE CONTEXT MANAGEMENT
        // ============================================

        let currentPageContextId = null;
        let currentPageContextData = null;
        let currentTips = [];

        async function loadPageContextList() {
            const select = document.getElementById('page-context-select');
            select.innerHTML = '<option value="">-- Select a page --</option>';

            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('chatbotPageContext').orderBy('order').get();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${data.name?.en || doc.id} (${data.isActive ? 'âœ…' : 'âŒ'})`;
                    select.appendChild(option);
                });

                console.log(`[Admin] Loaded ${snapshot.size} page contexts`);
            } catch (error) {
                console.error('[Admin] Failed to load page contexts:', error);
            }
        }

        async function loadPageContext(pageId) {
            if (!pageId) {
                document.getElementById('page-context-editor').style.display = 'none';
                return;
            }

            try {
                const db = firebase.firestore();
                const doc = await db.collection('chatbotPageContext').doc(pageId).get();

                if (!doc.exists) {
                    alert('Page context not found');
                    return;
                }

                currentPageContextId = pageId;
                currentPageContextData = doc.data();
                currentTips = currentPageContextData.tips || [];

                // Populate form
                document.getElementById('ctx-name-en').value = currentPageContextData.name?.en || '';
                document.getElementById('ctx-name-ko').value = currentPageContextData.name?.ko || '';
                document.getElementById('ctx-desc-en').value = currentPageContextData.description?.en || '';
                document.getElementById('ctx-desc-ko').value = currentPageContextData.description?.ko || '';
                document.getElementById('ctx-is-active').checked = currentPageContextData.isActive !== false;

                // Render tips
                renderTips();

                document.getElementById('page-context-editor').style.display = 'block';

            } catch (error) {
                console.error('[Admin] Failed to load page context:', error);
                alert('Error loading page context');
            }
        }

        function renderTips() {
            const container = document.getElementById('tips-container');
            container.innerHTML = '';

            currentTips.forEach((tip, index) => {
                const tipEl = document.createElement('div');
                tipEl.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; padding: 12px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px;';
                tipEl.innerHTML = `
                    <input type="text" class="admin-input tip-en" data-index="${index}" placeholder="Tip in English..." value="${tip.en || ''}">
                    <input type="text" class="admin-input tip-ko" data-index="${index}" placeholder="íŒ (í•œêµ­ì–´)..." value="${tip.ko || ''}">
                    <button type="button" class="admin-btn-secondary btn-remove-tip" data-index="${index}" style="padding: 8px 12px; color: #ef4444;">ğŸ—‘ï¸</button>
                `;
                container.appendChild(tipEl);
            });

            // Add event listeners
            container.querySelectorAll('.tip-en, .tip-ko').forEach(input => {
                input.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    const lang = e.target.classList.contains('tip-en') ? 'en' : 'ko';
                    if (!currentTips[idx]) currentTips[idx] = {};
                    currentTips[idx][lang] = e.target.value;
                });
            });

            container.querySelectorAll('.btn-remove-tip').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    currentTips.splice(idx, 1);
                    renderTips();
                });
            });
        }

        function addTip() {
            currentTips.push({ en: '', ko: '' });
            renderTips();
        }

        async function savePageContext() {
            if (!currentPageContextId) return;

            const data = {
                name: {
                    en: document.getElementById('ctx-name-en').value,
                    ko: document.getElementById('ctx-name-ko').value
                },
                description: {
                    en: document.getElementById('ctx-desc-en').value,
                    ko: document.getElementById('ctx-desc-ko').value
                },
                tips: currentTips.filter(t => t.en || t.ko),
                isActive: document.getElementById('ctx-is-active').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                const db = firebase.firestore();
                await db.collection('chatbotPageContext').doc(currentPageContextId).update(data);

                alert('âœ… Page context saved!');
                loadPageContextList();
            } catch (error) {
                console.error('[Admin] Failed to save page context:', error);
                alert('âŒ Error saving page context');
            }
        }

        // ============================================
        // VOICE SETTINGS
        // ============================================

        async function loadVoiceSettings() {
            try {
                const db = firebase.firestore();
                const doc = await db.collection('chatbotConfig').doc('default').get();

                if (doc.exists) {
                    const config = doc.data();
                    document.getElementById('voice-input-enabled').checked = config.voiceInputEnabled || false;
                    document.getElementById('voice-output-enabled').checked = config.voiceOutputEnabled || false;
                }
            } catch (error) {
                console.error('[Admin] Failed to load voice settings:', error);
            }
        }

        async function saveVoiceSettings() {
            try {
                const db = firebase.firestore();
                await db.collection('chatbotConfig').doc('default').update({
                    voiceEnabled: true,
                    voiceInputEnabled: document.getElementById('voice-input-enabled').checked,
                    voiceOutputEnabled: document.getElementById('voice-output-enabled').checked,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('âœ… Voice settings saved!');
            } catch (error) {
                console.error('[Admin] Failed to save voice settings:', error);
                alert('âŒ Error saving voice settings');
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        // Initialize immediately since this HTML is dynamically loaded
        // (DOMContentLoaded has already fired when admin.js loads this page)
        function initChatbotAdmin() {
            console.log('[Chatbot Admin] Initializing tabs and event listeners...');

            initChatbotTabs();

            // Page Context
            document.getElementById('page-context-select')?.addEventListener('change', (e) => {
                loadPageContext(e.target.value);
            });

            document.getElementById('btn-refresh-pages')?.addEventListener('click', loadPageContextList);
            document.getElementById('btn-add-tip')?.addEventListener('click', addTip);
            document.getElementById('btn-save-page-context')?.addEventListener('click', savePageContext);

            // Voice
            document.getElementById('btn-save-voice')?.addEventListener('click', saveVoiceSettings);

            console.log('[Chatbot Admin] Initialization complete');
        }

        // Run immediately
        initChatbotAdmin();

        // Also expose globally for admin.js compatibility
        window.initChatbot = initChatbotAdmin;
    </script>