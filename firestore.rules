// Firestore Security Rules for ZYNK AGENT OS - Phase 1
// 경로: Firebase Console → Firestore Database → Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function: Check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    // --- CORE SYSTEM SETTINGS (High Priority) ---
    
    // 5-Step Pipeline Settings: Admin can write, Public read
    match /pipelineSettings/{stepId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // System LLM Providers (OpenAI, etc.)
    match /systemLLMProviders/{providerId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Helper function: Check if user owns the project
    function isProjectOwner(projectId) {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid;
    }

    // ============================================
    // ZYNK AGENT OS Collections
    // ============================================
    
    // Sub-Agents: Admin can write, authenticated users can read
    match /projects/{projectId}/subAgents/{subAgentId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // AgentSets: Admin can write, authenticated users can read
    match /projects/{projectId}/agentSets/{agentSetId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Agent Tasks: Project owner and admin can read/write
    match /projects/{projectId}/agentTasks/{taskId} {
      allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      allow create: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      allow update: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Artifacts: Project owner and admin can read, system can write
    match /projects/{projectId}/artifacts/{artifactId} {
      allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      allow write: if isAdmin(); // In Phase 2, Cloud Functions will write
    }
    
    // Sub-Agent History: Admin only
    match /projects/{projectId}/subAgent_history/{historyId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // AgentSet History: Admin only
    match /projects/{projectId}/agentSet_history/{historyId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ============================================
    // Pricing & Credits System
    // ============================================

    // Pricing Plans: Admin write, Authenticated read
    match /system_pricing_plans/{planId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Top-up Packs: Admin write, Authenticated read
    match /system_topup_packs/{packId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Credit Action Costs: Admin write, Authenticated read
    match /system_credit_costs/{costId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Credit Transactions: User can create their own records
    match /credit_transactions/{transactionId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // No update/delete allowed for audit trail
    }

    // ============================================
    // Existing Collections (기존 규칙 유지)
    // ============================================
    
    // Users collection
    match /users/{uid} {
      allow read: if isAuthenticated();
      allow write: if request.auth.uid == uid;
      allow read: if isAdmin();
      
      // Credit history - user can read their own, system writes
      match /creditHistory/{historyId} {
        allow read: if request.auth.uid == uid || isAdmin();
        allow write: if isAdmin(); // Cloud Functions only
      }
    }
    
    // Projects collection
    match /projects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
      
      // Project sub-agents (nested)
      match /agents/{agentId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid || isAdmin());
      }

      // Agent Runs (Mission Control History)
      match /agentRuns/{runId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create: if isAuthenticated() && isProjectOwner(projectId);  // User can start runs
        allow update: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());  // User can update run status
        allow delete: if isAdmin();
      }

      // Generated Content (Mission Control History)
      match /generatedContents/{contentId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create: if isAuthenticated() && isProjectOwner(projectId);  // Agent can create content
        allow update: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());  // User can approve/reject
        allow delete: if isAdmin();
      }

      // Knowledge Sources (Knowledge Hub)
      match /knowledgeSources/{sourceId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create: if isAuthenticated() && isProjectOwner(projectId);
        allow update: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow delete: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      }

      // Foundational Data (Knowledge Hub output)
      match /foundationalData/{docId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow write: if isAdmin(); // Cloud Functions will write
      }


      // Content Plans (Knowledge Hub)
      match /contentPlans/{planId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create: if isAuthenticated() && isProjectOwner(projectId);
        allow update: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow delete: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      }

      // Saved Plans (Knowledge Hub - user generated plans)
      match /savedPlans/{planId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create: if isAuthenticated() && isProjectOwner(projectId);
        allow update: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow delete: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      }

      // Summary Feedback (Knowledge Hub - user feedback on AI summaries)
      match /summaryFeedback/{feedbackId} {
        allow read: if isAdmin();
        allow create: if isAuthenticated() && isProjectOwner(projectId);
      }

      // Brand Summaries (Knowledge Hub - Brand Intelligence)
      match /brandSummaries/{summaryId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create, update: if isAuthenticated() && isProjectOwner(projectId);
        allow delete: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      }

      // One Pagers (Marketing Assets)
      match /onePagers/{docId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create, update: if isAuthenticated() && isProjectOwner(projectId);
        allow delete: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      }

      // Brochures (Marketing Assets)
      match /brochures/{docId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create, update: if isAuthenticated() && isProjectOwner(projectId);
        allow delete: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      }

      // Promo Images (Social Content)
      match /promoImages/{docId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create, update: if isAuthenticated() && isProjectOwner(projectId);
        allow delete: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      }

      // Pitch Decks (Sales Assets)
      match /pitchDecks/{docId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create, update: if isAuthenticated() && isProjectOwner(projectId);
        allow delete: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      }

      // Generated Images (Knowledge Hub / Studio)
      match /generatedImages/{imageId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create, update: if isAuthenticated() && isProjectOwner(projectId);
        allow delete: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      }

      // Scheduled Content (Calendar / Scheduling)
      match /scheduledContent/{scheduleId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create: if isAuthenticated() && isProjectOwner(projectId);
        allow update: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow delete: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      }

      // Documents (Admin managed, User readable)
      match /documents/{docId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
        
        // Document History
        match /history/{historyId} {
            allow read: if isAuthenticated();
            allow write: if isAdmin();
        }
      }
      
      // Market Pulse Data (Scheduler output & Real-time trends)
      match /marketPulse/{docId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow write: if isAdmin(); // Cloud Functions & Admin
      }

      // Research History (Intelligence Lab results)
      match /researchHistory/{docId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create: if isAuthenticated() && isProjectOwner(projectId);
        allow write: if isAdmin();
      }

      // Brand Health History (Brand Brain health score tracking)
      match /brandHealthHistory/{historyId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow create: if isAuthenticated() && isProjectOwner(projectId);
        allow write: if isAdmin();
      }
    }

    // System Settings (Admin only)
    match /systemSettings/{settingId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // System Config (UI Layouts, etc.) - Public Read, Admin Write
    match /system_config/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Industries collection
    match /industries/{industryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // [TEMP] Allow public write for seeding Agent Registry
    match /agentRegistry/{document=**} {
      allow read, write: if true;
    }
    match /agentVersions/{document=**} {
      allow read, write: if true;
    }

    // Master agents library
    match /agents/{agentId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Runtime Profile Rules: Admin only (system configuration)
    // Users access runtime configs via snapshots in projectAgentTeamInstances/subAgents
    match /runtimeProfileRules/{ruleId} {
      allow read, write: if isAdmin();
    }

    // Runtime Profiles: REMOVED (Migrated to Runtime Profile Rules)
    // match /runtimeProfiles/{profileId} {
    //   allow read: if isAuthenticated();
    //   allow write: if isAdmin();
    // }

    // Workflow Definitions (5-Step Pipeline workflows)
    match /workflowDefinitions/{workflowId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.createdBy == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }

    // Agent Set Templates (Root): Admin can write, authenticated users can read
    match /agentSetTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Sub-Agent Templates (Root): Admin can write, authenticated users can read
    match /subAgentTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Agent Teams (Legacy/Simple): Admin can write, authenticated users can read
    match /agentTeams/{teamId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Project Agent Team Instances: Admin can write, authenticated users can read
    match /projectAgentTeamInstances/{instanceId} {
      allow read: if isAuthenticated();
      // Allow create if user owns the project specified in the data
      allow create: if isAuthenticated() && isProjectOwner(request.resource.data.projectId);
      // Allow update if user owns the project
      allow update: if isAuthenticated() && isProjectOwner(resource.data.projectId);
      // Admin has full access
      allow write: if isAdmin();
      
      // Sub-Agents within Team Instances
      match /subAgents/{agentId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin() || isProjectOwner(get(/databases/$(database)/documents/projectAgentTeamInstances/$(instanceId)).data.projectId);
      }
    }

    // Channel Profiles: Admin can write, Public can read (for Landing Page)
    match /channelProfiles/{profileId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Creative Studio Projects (Studio Assets)
    match /creativeProjects/{projectId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // Channel Profile Versions: Admin can write, authenticated users can read
    match /channelProfileVersions/{versionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }



    // ============================================
    // PRD 11.6 - LLM Router & Booster System
    // ============================================

    // LLM Models Catalog: Public read (for cost reference), Admin write
    match /systemLLMModels/{modelId} {
      allow read: if isAuthenticated();  // Users need to see model costs
      allow write: if isAdmin();
    }

    // Feature Policies: Public read (for routing decisions), Admin write
    match /featurePolicies/{policyId} {
      allow read: if isAuthenticated();  // Frontend needs for Booster UX
      allow write: if isAdmin();
    }

    // LLM Usage Logs: Cloud Functions write, Admin read, User read own
    match /llmUsageLogs/{logId} {
      allow read: if isAdmin() || 
                     (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow write: if true;  // Cloud Functions need to write
    }

    // System Prompt Templates: Authenticated users can read/write (Dev Mode)
    match /systemPromptTemplates/{templateId} {
      allow read, write: if request.auth != null;
    }

    // Sub-Agent Channel Adapters: Authenticated users can read/write (Dev Mode)
    match /subAgentChannelAdapters/{adapterId} {
      allow read, write: if request.auth != null;
    }

    // User API Credentials (PRD 11.0 Phase 2): Users can only access their own credentials
    match /userApiCredentials/{credId} {
      // Users can read their own credentials (including queries filtered by userId)
      allow read: if isAuthenticated() && 
                     (resource == null || resource.data.userId == request.auth.uid);
      // Users can write their own credentials
      allow write: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
      // Allow creation if userId matches auth uid
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      // Admins can read all credentials
      allow read: if isAdmin();
    }

    // ============================================
    // Brand Brain Collection (User-specific brand strategy data)
    // ============================================
    match /brandBrain/{userId} {
      // User can read/write their own brandBrain document
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      
      // Projects sub-collection
      match /projects/{projectId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
        
        // Sources sub-collection (Drive files, Links, Notes)
        match /sources/{sourceId} {
          allow read, write: if isAuthenticated() && request.auth.uid == userId;
        }
      }
    }

    // ============================================
    // AI Helpdesk Chatbot Collections
    // ============================================
    
    // Chatbot Config: Admin can write, Cloud Functions can read
    match /chatbotConfig/{configId} {
      allow read: if true;  // Cloud Functions need to read
      allow write: if isAdmin();
    }
    
    // Chatbot Usage: Cloud Functions manage, users can read their own
    match /chatbotUsage/{usageId} {
      allow read: if true;  // Cloud Functions need to read
      allow write: if true;  // Cloud Functions need to write
    }
    
    // Chatbot Page Context: Admin can write, authenticated users can read
    match /chatbotPageContext/{pageId} {
      allow read: if isAuthenticated();  // Users need to read for context
      allow write: if isAdmin();  // Only Admin can modify
    }


  }
}
