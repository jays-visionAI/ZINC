// Firestore Security Rules for ZYIC AGENT OS - Phase 1
// 경로: Firebase Console → Firestore Database → Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function: Check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }
    
    // Helper function: Check if user owns the project
    function isProjectOwner(projectId) {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid;
    }

    // ============================================
    // ZYIC AGENT OS Collections
    // ============================================
    
    // Sub-Agents: Admin can write, authenticated users can read
    match /projects/{projectId}/subAgents/{subAgentId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // AgentSets: Admin can write, authenticated users can read
    match /projects/{projectId}/agentSets/{agentSetId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Agent Tasks: Project owner and admin can read/write
    match /projects/{projectId}/agentTasks/{taskId} {
      allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      allow create: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      allow update: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Artifacts: Project owner and admin can read, system can write
    match /projects/{projectId}/artifacts/{artifactId} {
      allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
      allow write: if isAdmin(); // In Phase 2, Cloud Functions will write
    }
    
    // Sub-Agent History: Admin only
    match /projects/{projectId}/subAgent_history/{historyId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // AgentSet History: Admin only
    match /projects/{projectId}/agentSet_history/{historyId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ============================================
    // Existing Collections (기존 규칙 유지)
    // ============================================
    
    // Users collection
    match /users/{uid} {
      allow read: if isAuthenticated();
      allow write: if request.auth.uid == uid;
      allow read: if isAdmin();
    }
    
    // Projects collection
    match /projects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
      
      // Project sub-agents (nested)
      match /agents/{agentId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid || isAdmin());
      }

      // Agent Runs (Mission Control History)
      match /agentRuns/{runId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow write: if isAdmin();
      }

      // Generated Content (Mission Control History)
      match /generatedContents/{contentId} {
        allow read: if isAuthenticated() && (isProjectOwner(projectId) || isAdmin());
        allow write: if isAdmin();
      }

      // Documents (Admin managed, User readable)
      match /documents/{docId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
        
        // Document History
        match /history/{historyId} {
            allow read: if isAuthenticated();
            allow write: if isAdmin();
        }
      }
    }
    
    // Industries collection
    match /industries/{industryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Master agents library
    match /agents/{agentId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Runtime Profile Rules: Admin only (system configuration)
    // Users access runtime configs via snapshots in projectAgentTeamInstances/subAgents
    match /runtimeProfileRules/{ruleId} {
      allow read, write: if isAdmin();
    }

    // Runtime Profiles: REMOVED (Migrated to Runtime Profile Rules)
    // match /runtimeProfiles/{profileId} {
    //   allow read: if isAuthenticated();
    //   allow write: if isAdmin();
    // }

    // Agent Set Templates (Root): Admin can write, authenticated users can read
    match /agentSetTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Sub-Agent Templates (Root): Admin can write, authenticated users can read
    match /subAgentTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Project Agent Team Instances: Admin can write, authenticated users can read
    match /projectAgentTeamInstances/{instanceId} {
      allow read: if isAuthenticated();
      // Allow create if user owns the project specified in the data
      allow create: if isAuthenticated() && isProjectOwner(request.resource.data.projectId);
      // Allow update if user owns the project
      allow update: if isAuthenticated() && isProjectOwner(resource.data.projectId);
      // Admin has full access
      allow write: if isAdmin();
      
      // Sub-Agents within Team Instances
      match /subAgents/{agentId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin() || isProjectOwner(get(/databases/$(database)/documents/projectAgentTeamInstances/$(instanceId)).data.projectId);
      }
    }

    // Channel Profiles: Admin can write, authenticated users can read
    match /channelProfiles/{profileId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // System LLM Providers: Admin only (Secure storage for API Keys)
    match /systemLLMProviders/{providerId} {
      allow read, write: if isAdmin();
    }

    // System Prompt Templates: Authenticated users can read/write (Dev Mode)
    match /systemPromptTemplates/{templateId} {
      allow read, write: if request.auth != null;
    }

    // Sub-Agent Channel Adapters: Authenticated users can read/write (Dev Mode)
    match /subAgentChannelAdapters/{adapterId} {
      allow read, write: if request.auth != null;
    }

    // User API Credentials (PRD 11.0 Phase 2): Users can only access their own credentials
    match /userApiCredentials/{credId} {
      // Users can read and write their own credentials
      allow read, write: if isAuthenticated() && 
                            resource.data.userId == request.auth.uid;
      // Allow creation if userId matches auth uid
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      // Admins can read metadata (but encrypted fields remain encrypted)
      allow read: if isAdmin();
    }
  }
}
